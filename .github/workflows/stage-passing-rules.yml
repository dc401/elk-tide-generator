name: Stage Passing Detection Rules
on:
  workflow_run:
    workflows: ["LLM Judge Quality Evaluation"]
    types:
      - completed
  workflow_dispatch:

jobs:
  stage-rules:
    name: Stage Rules for Human Review
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check for Quality Report
        run: |
          if [ ! -f "generated/QUALITY_REPORT.json" ]; then
            echo "ERROR: Quality report not found"
            echo "Run LLM judge evaluation first"
            exit 1
          fi
          echo "Found quality report"

      - name: Check for Integration Test Results
        run: |
          if [ ! -f "generated/INTEGRATION_TEST_RESULTS.json" ]; then
            echo "ERROR: Integration test results not found"
            exit 1
          fi
          echo "Found integration test results"

      - name: Filter Passing Rules
        id: filter
        run: |
          python3 scripts/filter_passing_rules.py

      - name: Commit Staged Rules
        if: steps.filter.outputs.rule_count > 0
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add staged_rules/

          if git diff --staged --quiet; then
            echo "No new staged rules to commit"
          else
            BATCH_ID="${{ steps.filter.outputs.batch_id }}"
            RULE_COUNT="${{ steps.filter.outputs.rule_count }}"

            git commit -m "ci: Stage $RULE_COUNT rules for review (batch $BATCH_ID) [skip ci]"
            git push
          fi

      - name: Create Review PR
        if: steps.filter.outputs.rule_count > 0
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BATCH_ID="${{ steps.filter.outputs.batch_id }}"
          RULE_COUNT="${{ steps.filter.outputs.rule_count }}"
          BRANCH_NAME="detection-review-$(date +%Y%m%d-%H%M%S)"

          #create new branch from main
          git checkout -b "$BRANCH_NAME"
          git push -u origin "$BRANCH_NAME"

          #create PR
          gh pr create \
            --base main \
            --head "$BRANCH_NAME" \
            --title "Review Detection Rules - Batch $BATCH_ID" \
            --body "Review $RULE_COUNT detection rules that passed all quality gates. Check staged_rules/ for Sigma YAMLs and quality reports in generated/" \
            --label "detection-review" \
            --label "needs-human-review"

          echo "✓ Created PR for human review on branch: $BRANCH_NAME"

      - name: Summary
        run: |
          if [ "${{ steps.filter.outputs.rule_count }}" -gt 0 ]; then
            echo "✅ Staged ${{ steps.filter.outputs.rule_count }} rules for human review"
            echo "PR created for batch: ${{ steps.filter.outputs.batch_id }}"
          else
            echo "⚠️  No rules passed quality gates"
            echo "Improve rule quality or adjust thresholds"
          fi
