name: Mock SIEM Deployment
on:
  pull_request:
    types: [closed]
    branches: [main]
    paths:
      - 'staged_rules/**'

jobs:
  mock-deploy:
    name: Mock Production Deployment
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    timeout-minutes: 15

    services:
      elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:8.12.0
        env:
          discovery.type: single-node
          xpack.security.enabled: false
          ES_JAVA_OPTS: -Xms512m -Xmx512m
        ports:
          - 9200:9200
        options: >-
          --health-cmd "curl -f http://localhost:9200/_cluster/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 30

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          echo "Installing dependencies..."

          pip install elasticsearch pysigma pysigma-backend-elasticsearch pyyaml
          echo "✓ Dependencies installed successfully"


      - name: Wait for Elasticsearch
        run: |
          echo "Waiting for Elasticsearch to be ready..."
          timeout 120 bash -c 'until curl -s http://localhost:9200/_cluster/health | grep -q "green\|yellow"; do sleep 2; done'
          echo "Elasticsearch ready"

      - name: Mock Production Deployment
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          APPROVED_BY: ${{ github.event.pull_request.merged_by.login }}
        run: |
          python3 scripts/mock_deploy.py

      - name: Move Rules to Production
        run: |
          mkdir -p production_rules

          #copy staged rules to production
          cp staged_rules/*.yml production_rules/ 2>/dev/null || true
          cp staged_rules/*.yaml production_rules/ 2>/dev/null || true

          RULE_COUNT=$(ls production_rules/*.yml production_rules/*.yaml 2>/dev/null | wc -l)
          echo "Moved $RULE_COUNT rules to production_rules/"

          #archive staged rules
          mkdir -p archived_rules
          ARCHIVE_DIR="archived_rules/deployed_$(date +%Y%m%d_%H%M%S)"
          mkdir -p "$ARCHIVE_DIR"

          mv staged_rules/* "$ARCHIVE_DIR/" 2>/dev/null || true

          echo "Archived staged rules to: $ARCHIVE_DIR"

      - name: Commit Production Rules
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add production_rules/
          git add archived_rules/

          #remove now-empty staged rules if any
          git add staged_rules/

          RULE_COUNT=$(ls production_rules/*.yml production_rules/*.yaml 2>/dev/null | wc -l)

          git commit -m "ci: Deploy $RULE_COUNT rules to production (PR #${{ github.event.pull_request.number }})"

          git push

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const manifest = JSON.parse(fs.readFileSync('production_rules/DEPLOYMENT_MANIFEST.json', 'utf8'));

            const comment = `## ✅ Mock Deployment Complete

            **Deployment Details:**
            - Rules Deployed: ${manifest.rules.length}
            - Deployed At: ${manifest.deployed_at}
            - Approved By: @${manifest.approved_by}

            **Rules in Production:**
            ${manifest.rules.map(r => `- ${r.title} (\`${r.file}\`)`).join('\n')}

            **Next Steps:**
            These rules have been validated with mock Elasticsearch and are now in \`production_rules/\`.

            In a real deployment, you would now:
            1. Convert rules to your SIEM's native format
            2. Deploy to production SIEM via API or UI
            3. Monitor for alerts and false positives
            4. Iterate based on production feedback

            ---
            *Automated Mock Deployment - GitHub Actions*
            `;

            github.rest.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Summary
        run: |
          echo "================================"
          echo "✅ Mock Deployment Successful"
          echo "================================"
          echo ""
          echo "Rules deployed to production_rules/"
          echo "Staged rules archived"
          echo ""
          echo "This demonstrates the full quality-gated pipeline:"
          echo "  1. Generate → Static LLM Judge → Filter"
          echo "  2. Convert Sigma → ELK → Validate"
          echo "  3. Integration Test → Real ELK"
          echo "  4. Stage → Human Review → PR"
          echo "  5. Approve → Mock Deploy → Production"
          echo ""
