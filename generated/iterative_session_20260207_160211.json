{
  "cti_content": "Loaded 2 CTI files (~3,425 tokens)\nFiles chunked/summarized: 1\nRemaining token budget for analysis: ~1,045,151 tokens\n================================================================================\n\n================================================================================\nFILE: sample-gcp-threats.md\n================================================================================\n# GCP IAM Privilege Escalation Campaign - APT-Cloud-Hunter\n\n## Executive Summary\nAdvanced threat actor APT-Cloud-Hunter has been observed targeting Google Cloud Platform (GCP) environments with sophisticated privilege escalation techniques focused on IAM service account abuse.\n\n## Threat Actor Profile\n- **Name:** APT-Cloud-Hunter\n- **Aliases:** CloudStrike, GCP-Shadow\n- **Motivation:** Espionage, data theft\n- **Sophistication:** High\n- **First Observed:** 2024-Q2\n- **Targets:** Cloud-native organizations, SaaS providers, financial services\n\n## Attack Chain\n\n### 1. Initial Access (T1078.004 - Valid Accounts: Cloud Accounts)\n- Compromised service account credentials via phishing or credential stuffing\n- Exploited misconfigured Cloud Storage buckets containing service account keys\n- Target: Low-privilege service accounts in development projects\n\n### 2. Discovery (T1087.004 - Account Discovery: Cloud Account)\n- Enumerate IAM policies: `gcloud projects get-iam-policy`\n- List service accounts: `gcloud iam service-accounts list`\n- Identify high-privilege service accounts with `roles/iam.serviceAccountTokenCreator`\n\n### 3. Privilege Escalation (T1550.001 - Use Alternate Authentication Material)\n**Primary TTP: Service Account Impersonation**\n- Use `GenerateAccessToken` API to impersonate high-privilege service accounts\n- Target accounts with `roles/owner`, `roles/editor`, or custom admin roles\n- Bypass MFA by using service account tokens instead of user accounts\n\n**GCP API Calls Observed:**\n```\niam.serviceAccounts.getAccessToken\niam.serviceAccounts.implicitDelegation\niam.serviceAccounts.generateAccessToken\n```\n\n**Example Attack Command:**\n```bash\ngcloud iam service-accounts generate-access-token \\\n  highly-privileged-sa@project.iam.gserviceaccount.com \\\n  --impersonate-service-account=victim-sa@project.iam.gserviceaccount.com\n```\n\n### 4. Lateral Movement (T1021.007 - Cloud Services)\n- Use elevated privileges to access other GCP projects\n- Modify IAM policies to grant persistent access\n- Create new service accounts as backdoors\n\n### 5. Data Exfiltration (T1567.002 - Cloud Storage)\n- Export BigQuery datasets to attacker-controlled Cloud Storage buckets\n- Download sensitive files from Cloud Storage\n- Exfiltrate data via Cloud Functions with outbound internet access\n\n## Key Indicators of Compromise (IOCs)\n\n### GCP Audit Log Patterns\n1. **Unusual GenerateAccessToken API calls:**\n   - `protoPayload.methodName: \"GenerateAccessToken\"`\n   - `protoPayload.authenticationInfo.principalEmail` does NOT end with `.gserviceaccount.com`\n   - Multiple calls within short timeframe (5+ within 10 minutes)\n\n2. **Service Account Impersonation from External Users:**\n   - User account (not service account) calling `iam.serviceAccounts.implicitDelegation`\n   - Source IP outside normal GCP IP ranges\n   - Off-hours activity (outside business hours)\n\n3. **IAM Policy Modifications:**\n   - `SetIamPolicy` calls adding `roles/iam.serviceAccountTokenCreator`\n   - Binding modifications granting `roles/owner` to new principals\n   - Policy changes from non-admin accounts\n\n4. **Suspicious BigQuery Data Access:**\n   - Large dataset exports (>10GB) to external storage\n   - `bigquery.datasets.export` to non-organizational buckets\n   - Unusual query patterns accessing sensitive tables\n\n## Detection Opportunities\n\n### High-Priority Detections\n\n**1. External User Service Account Impersonation**\n- **Log Source:** GCP Audit Logs (Admin Activity)\n- **Detection Logic:**\n  - `serviceName = \"iam.googleapis.com\"`\n  - `methodName = \"GenerateAccessToken\"`\n  - `authenticationInfo.principalEmail` NOT like `%@%.gserviceaccount.com`\n- **False Positive Risk:** LOW (legitimate use rare)\n- **Severity:** HIGH\n\n**2. Excessive Service Account Token Generation**\n- **Log Source:** GCP Audit Logs (Admin Activity)\n- **Detection Logic:**\n  - Count `GenerateAccessToken` calls per principal\n  - Threshold: >5 calls in 10 minutes\n  - Group by `authenticationInfo.principalEmail`\n- **False Positive Risk:** MEDIUM (CI/CD pipelines may trigger)\n- **Severity:** MEDIUM\n\n**3. Off-Hours IAM Policy Modifications**\n- **Log Source:** GCP Audit Logs (Admin Activity)\n- **Detection Logic:**\n  - `methodName = \"SetIamPolicy\"`\n  - Timestamp outside business hours (e.g., 00:00-06:00 UTC)\n  - Excludes automated service accounts\n- **False Positive Risk:** MEDIUM (on-call engineers, global teams)\n- **Severity:** HIGH\n\n**4. Service Account Privilege Escalation**\n- **Log Source:** GCP Audit Logs (Admin Activity)\n- **Detection Logic:**\n  - `methodName = \"SetIamPolicy\"`\n  - `request.policy.bindings` contains `roles/iam.serviceAccountTokenCreator`\n  - `request.policy.bindings` contains `roles/owner` OR `roles/editor`\n- **False Positive Risk:** LOW\n- **Severity:** CRITICAL\n\n## Defensive Recommendations\n\n1. **IAM Policy Hardening:**\n   - Restrict `roles/iam.serviceAccountTokenCreator` to trusted principals only\n   - Implement organization policy constraint: `iam.disableServiceAccountKeyCreation`\n   - Use short-lived tokens (Workload Identity Federation)\n\n2. **Monitoring & Alerting:**\n   - Enable Cloud Audit Logs for all GCP services\n   - Forward logs to SIEM (Chronicle, Splunk, ELK)\n   - Implement detections outlined above\n\n3. **Access Controls:**\n   - Enforce VPC Service Controls to restrict service account usage\n   - Require MFA for all human users\n   - Separate dev/staging/prod projects with strict IAM boundaries\n\n## MITRE ATT&CK Mapping\n\n| Tactic | Technique | ID | GCP Context |\n|--------|-----------|-----|-------------|\n| Initial Access | Valid Accounts: Cloud Accounts | T1078.004 | Compromised service account credentials |\n| Discovery | Account Discovery: Cloud Account | T1087.004 | Enumerate IAM policies and service accounts |\n| Privilege Escalation | Use Alternate Authentication Material | T1550.001 | Service account impersonation via GenerateAccessToken |\n| Persistence | Account Manipulation | T1098.001 | Create backdoor service accounts |\n| Lateral Movement | Remote Services: Cloud Services | T1021.007 | Access other GCP projects |\n| Exfiltration | Transfer Data to Cloud Account | T1537 | Export BigQuery data to attacker-controlled storage |\n\n## References\n- [GCP IAM Service Account Documentation](https://cloud.google.com/iam/docs/service-accounts)\n- [GCP Audit Logs Reference](https://cloud.google.com/logging/docs/audit)\n- [MITRE ATT&CK for Cloud](https://attack.mitre.org/matrices/enterprise/cloud/)\n- [Service Account Impersonation Best Practices](https://cloud.google.com/iam/docs/impersonating-service-accounts)\n\n## Appendix: Sample GCP Audit Log\n\n```json\n{\n  \"protoPayload\": {\n    \"serviceName\": \"iam.googleapis.com\",\n    \"methodName\": \"GenerateAccessToken\",\n    \"authenticationInfo\": {\n      \"principalEmail\": \"attacker@external-domain.com\"\n    },\n    \"requestMetadata\": {\n      \"callerIp\": \"203.0.113.42\"\n    },\n    \"request\": {\n      \"name\": \"projects/-/serviceAccounts/admin-sa@victim-project.iam.gserviceaccount.com\",\n      \"delegates\": [],\n      \"scope\": [\"https://www.googleapis.com/auth/cloud-platform\"]\n    },\n    \"response\": {\n      \"accessToken\": \"[REDACTED]\",\n      \"expireTime\": \"2024-12-25T13:00:00Z\"\n    }\n  },\n  \"resource\": {\n    \"type\": \"service_account\",\n    \"labels\": {\n      \"project_id\": \"victim-project\",\n      \"unique_id\": \"112233445566778899\"\n    }\n  },\n  \"timestamp\": \"2024-12-25T12:00:00Z\",\n  \"severity\": \"NOTICE\"\n}\n```\n\n---\n\n**Report Date:** 2024-12-25  \n**Analyst:** Threat Intelligence Team  \n**Classification:** CONFIDENTIAL\n\n================================================================================\nFILE: wiz-Scattered Spider targeting GCP environment.pdf (CHUNKED SUMMARY)\n================================================================================\n--- Chunk 1/1 ---\nHere's a detailed extraction of threat intelligence from the provided document chunk:\n\n---\n\n### Threat Intelligence Extraction: Scattered Spider targeting GCP environment\n\n**1. Threat Actors/Groups:**\n*   **Scattered Spider:** The primary threat group identified as orchestrating the campaign.\n*   **Oktapus:** Listed specifically as the \"Actor\" involved in this incident, potentially an alias for Scattered Spider in this context, a subgroup, or a closely associated entity.\n\n**2. TTPs and MITRE ATT&CK Techniques:**\n\nThe following techniques were observed:\n\n*   **Create or modify firewall or security group rules:**\n    *   **Description:** Attackers manipulate cloud-native network access controls (e.g., GCP Firewall Rules) to permit unauthorized inbound/outbound traffic, facilitating C2, lateral movement, or data exfiltration, and/or to bypass existing security measures.\n    *   **MITRE ATT&CK (Cloud):**\n        *   **TA0003 - Persistence:** Opening ports for continued access.\n        *   **TA0008 - Defense Evasion:** Bypassing security controls.\n        *   **T1562.007 - Impair Defenses: Disable or Modify Cloud Security Controls** (Specific technique).\n\n*   **OS password reset:**\n    *   **Description:** Attackers reset operating system passwords for compute instances (e.g., GCP Compute Engine VMs), likely leveraging compromised cloud credentials to gain direct administrative access to the underlying OS.\n    *   **MITRE ATT&CK (Enterprise/Cloud):**\n        *   **TA0004 - Privilege Escalation:** Gaining higher privileges on the instance.\n        *   **T1098 - Account Manipulation:** Resetting passwords.\n        *   **T1098.006 - Account Manipulation: Cloud Account** (If facilitated via cloud API/console access).\n\n*   **Create SSH backdoor:**\n    *   **Description:** Attackers establish persistent, unauthorized SSH access to compute instances, typically by adding their own public keys to the `authorized_keys` file on Linux instances or by installing backdoor SSH services.\n    *   **MITRE ATT&CK (Enterprise/Cloud):**\n        *   **TA0003 - Persistence:** Establishing continued access.\n        *   **T1078.003 - Valid Accounts: Cloud Accounts** (If using legitimate cloud user to manage SSH keys).\n        *   **T1098.004 - Account Manipulation: SSH Authorized Keys** (Specific technique).\n\n*   **Modify compute startup script:**\n    *   **Description:** Attackers alter the metadata of cloud compute instances (e.g., GCP Compute Engine startup scripts) to execute malicious commands (e.g., establishing persistence, downloading malware, configuring C2) automatically upon instance boot or reboot.\n    *   **MITRE ATT&CK (Cloud):**\n        *   **TA0003 - Persistence:** Ensuring malicious code runs after reboots.\n        *   **T1574.004 - Hijack Execution Flow: Task Scheduler/Startup Script** (Applicable to cloud startup scripts).\n\n*   **Launch new cloud resources:**\n    *   **Description:** Attackers provision new infrastructure within the compromised GCP environment (e.g., additional Compute Engine instances, storage buckets, network components), potentially for staging further attacks, establishing C2 infrastructure, cryptocurrency mining, or expanding their operational footprint.\n    *   **MITRE ATT&CK (Cloud):**\n        *   **TA0001 - Initial Access:** (If used to create new access points).\n        *   **TA0003 - Persistence:** (If used for new C2 infrastructure).\n        *   **TA0009 - Impact:** (e.g., resource consumption for mining).\n        *   **T1578.001 - Create Cloud Instance** (Specific technique).\n\n*   **Delete compute snapshot:**\n    *   **Description:** Attackers remove snapshots of compute instances, which are critical for data recovery and business continuity. This action is characteristic of ransomware or destructive attacks, aimed at hindering the victim's ability to restore systems.\n    *   **MITRE ATT&CK (Cloud):**\n        *   **TA0009 - Impact:** Disrupting availability.\n        *   **T1490 - Inhibit System Recovery** (Directly applicable technique).\n\n**3. IOCs (Indicators of Compromise):**\n*   No explicit IPs, domains, hashes, or file paths are provided in this document chunk.\n\n**4. GCP/Cloud-Specific Details:**\n*   **Target Environment:** Google Cloud Platform (GCP).\n*   **Specific Cloud Services/Components Targeted/Leveraged:**\n    *   GCP Firewall Rules / Security Group Rules\n    *   GCP Compute Engine Instances (for OS password reset, SSH backdoor, startup script modification, new resource launch, and snapshot deletion)\n    *   GCP Snapshots\n*   **Observed Impact:** RansomOp (Ransomware Operations), indicating actions designed to extort money through data encryption or system disruption, often combined with data exfiltration.\n\n**5. Attack Chains and Procedures:**\n\n*   **Initial Access:** **Unknown** (explicitly stated).\n*   **Post-Initial Access / Exploitation & Persistence:**\n    1.  **Gaining Control/Persistence on Instances:**\n        *   Attackers perform **OS password resets** on target compute instances.\n        *   They create **SSH backdoors** on instances to ensure continued remote access.\n        *   They **modify compute startup scripts** to achieve persistence and execute malicious commands automatically upon instance boot.\n    2.  **Network Manipulation & Defense Evasion:**\n        *   Attackers **create or modify firewall or security group rules** to allow their malicious traffic, bypass existing security, or facilitate lateral movement/exfiltration.\n    3.  **Resource Expansion/Impact Prep:**\n        *   Attackers **launch new cloud resources**, potentially to expand their foothold, establish C2, or stage further operations like cryptocurrency mining or data exfiltration.\n    4.  **Impact (RansomOp Phase):**\n        *   Attackers **delete compute snapshots**, a critical step to prevent recovery and maximize the impact of a RansomOp campaign. This action strongly indicates an intent to disrupt services and coerce payment.\n\n---\n\n",
  "timestamp": "2026-02-07T15:51:16.965057",
  "cti_analysis": "[Event(model_version='gemini-2.5-pro', content=Content(\n  parts=[\n    Part(\n      text=\"\"\"{\n  \"threat_summary\": \"Analysis of recent CTI reveals two distinct threat actor campaigns targeting Google Cloud Platform. The first involves APT-Cloud-Hunter, a high-sophistication actor focused on espionage and data theft through advanced IAM abuse. This group compromises low-privilege service accounts, then uses service account impersonation (`GenerateAccessToken` API) to escalate privileges, move laterally across projects, and exfiltrate data from services like BigQuery and Cloud Storage. The second campaign is attributed to Scattered Spider, a financially motivated group conducting ransomware operations. This actor gains control over Compute Engine instances, establishes persistence by modifying startup scripts and adding SSH backdoors, manipulates firewall rules for C2 traffic, and ultimately deletes compute snapshots to inhibit recovery and pressure victims for payment. Both campaigns highlight critical attack paths in GCP, from initial credential compromise to impactful actions, underscoring the need for robust IAM hygiene, compute environment security, and vigilant monitoring of audit logs for anomalous activity.\",\n  \"threat_actors\": [\n    {\n      \"name\": \"APT-Cloud-Hunter\",\n      \"aliases\": [\n        \"CloudStrike\",\n        \"GCP-Shadow\"\n      ],\n      \"motivation\": \"Espionage, data theft\",\n      \"sophistication\": \"High\",\n      \"targets\": [\n        \"Cloud-native organizations\",\n        \"SaaS providers\",\n        \"Financial services\"\n      ]\n    },\n    {\n      \"name\": \"Scattered Spider\",\n      \"aliases\": [\n        \"Oktapus\"\n      ],\n      \"motivation\": \"Financial gain through ransomware operations (RansomOp)\",\n      \"sophistication\": \"Medium to High\",\n      \"targets\": [\n        \"Google Cloud Platform (GCP) environments\"\n      ]\n    }\n  ],\n  \"objectives\": [\n    \"Steal sensitive data from BigQuery and Cloud Storage for espionage.\",\n    \"Deploy ransomware and disrupt operations for financial extortion.\",\n    \"Escalate privileges to project Owner or equivalent administrative roles.\",\n    \"Move laterally across different GCP projects within an organization.\",\n    \"Establish long-term, persistent access through backdoor service accounts and SSH keys.\",\n    \"Inhibit system recovery by deleting compute instance snapshots.\",\n    \"Hijack cloud resources for malicious activities like C2 or cryptocurrency mining.\"\n  ],\n  \"attack_vectors\": [\n    \"Compromise of low-privilege service account credentials via phishing or credential stuffing.\",\n    \"Exploitation of misconfigured Cloud Storage buckets containing exposed service account keys.\",\n    \"Initial access vector for the Scattered Spider campaign is noted as unknown.\"\n  ],\n  \"ttps\": [\n    {\n      \"ttp_id\": \"\",\n      \"ttp_name\": \"Service Account Impersonation for Privilege Escalation\",\n      \"tactic\": \"Privilege Escalation\",\n      \"description\": \"After gaining access to a principal with the 'iam.serviceAccountTokenCreator' role, attackers use the 'iam.serviceAccounts.generateAccessToken' API to mint short-lived credentials for a higher-privilege service account. This allows them to assume the identity of that account without needing its key.\",\n      \"gcp_relevance\": \"This is a primary privilege escalation vector in GCP, allowing attackers to bypass MFA on user accounts and escalate from a low-privilege principal to a highly-privileged service account identity.\",\n      \"priority\": \"CRITICAL\",\n      \"evidence\": [\n        \"Quote from CTI: 'Use `GenerateAccessToken` API to impersonate high-privilege service accounts'\",\n        \"Quote from CTI: 'Bypass MFA by using service account tokens instead of user accounts'\",\n        \"Quote from CTI: 'GCP API Calls Observed: iam.serviceAccounts.generateAccessToken'\"\n      ]\n    },\n    {\n      \"ttp_id\": \"\",\n      \"ttp_name\": \"IAM Policy Modification for Privilege Escalation\",\n      \"tactic\": \"Privilege Escalation\",\n      \"description\": \"Attackers with sufficient permissions use the 'SetIamPolicy' API call to grant highly permissive roles, such as 'roles/owner' or 'roles/iam.serviceAccountTokenCreator', to accounts they control.\",\n      \"gcp_relevance\": \"Directly modifies the GCP resource hierarchy's access control policy to grant administrative privileges, providing the attacker with broad control over the project or organization.\",\n      \"priority\": \"CRITICAL\",\n      \"evidence\": [\n        \"Quote from CTI: 'Binding modifications granting `roles/owner` to new principals'\",\n        \"Quote from CTI: '`SetIamPolicy` calls adding `roles/iam.serviceAccountTokenCreator`'\"\n      ]\n    },\n    {\n      \"ttp_id\": \"\",\n      \"ttp_name\": \"Inhibit System Recovery by Deleting Snapshots\",\n      \"tactic\": \"Impact\",\n      \"description\": \"Attackers delete snapshots of Compute Engine instances. This action is typically performed as part of a ransomware campaign to prevent victims from restoring their systems from backups, thereby increasing the pressure to pay the ransom.\",\n      \"gcp_relevance\": \"Directly targets GCP's native backup and recovery mechanism for Compute Engine, causing significant operational disruption and hindering incident response.\",\n      \"priority\": \"CRITICAL\",\n      \"evidence\": [\n        \"Quote from CTI: 'Delete compute snapshot'\",\n        \"Quote from CTI: 'This action is characteristic of ransomware or destructive attacks, aimed at hindering the victim's ability to restore systems.'\"\n      ]\n    },\n    {\n      \"ttp_id\": \"\",\n      \"ttp_name\": \"Persistence via Compute Startup Script Modification\",\n      \"tactic\": \"Persistence\",\n      \"description\": \"Attackers modify the 'startup-script' metadata of a Compute Engine instance to execute malicious code or commands every time the instance boots or reboots. This ensures their tools or backdoors are re-established automatically.\",\n      \"gcp_relevance\": \"This is a powerful persistence mechanism on GCP compute instances, as the script runs with root privileges and is managed via the GCP metadata service, often outside of traditional host-based security monitoring.\",\n      \"priority\": \"HIGH\",\n      \"evidence\": [\n        \"Quote from CTI: 'Modify compute startup script'\",\n        \"Quote from CTI: 'Attackers alter the metadata of cloud compute instances (e.g., GCP Compute Engine startup scripts) to execute malicious commands'\"\n      ]\n    },\n    {\n      \"ttp_id\": \"\",\n      \"ttp_name\": \"Persistence via SSH Key Addition\",\n      \"tactic\": \"Persistence\",\n      \"description\": \"Attackers add their own public SSH keys to the metadata of a Compute Engine instance or project. This grants them persistent remote access to the virtual machine as the specified user.\",\n      \"gcp_relevance\": \"Abuses GCP's centralized SSH key management system to create a durable backdoor into compute resources, which can be difficult to spot if not monitoring metadata changes.\",\n      \"priority\": \"HIGH\",\n      \"evidence\": [\n        \"Quote from CTI: 'Create SSH backdoor'\",\n        \"Quote from CTI: 'attackers establish persistent, unauthorized SSH access to compute instances, typically by adding their own public keys'\"\n      ]\n    },\n    {\n      \"ttp_id\": \"\",\n      \"ttp_name\": \"Defense Evasion by Modifying Firewall Rules\",\n      \"tactic\": \"Defense Evasion\",\n      \"description\": \"Attackers create or modify GCP Firewall Rules to allow inbound or outbound traffic on specific ports, often to enable C2 communications or data exfiltration while bypassing existing network security controls.\",\n      \"gcp_relevance\": \"Manipulates GCP's software-defined networking layer to undermine network segmentation and security posture, allowing malicious traffic to flow.\",\n      \"priority\": \"HIGH\",\n      \"evidence\": [\n        \"Quote from CTI: 'Create or modify firewall or security group rules'\",\n        \"Quote from CTI: 'permit unauthorized inbound/outbound traffic, facilitating C2, lateral movement, or data exfiltration'\"\n      ]\n    },\n    {\n      \"ttp_id\": \"\",\n      \"ttp_name\": \"Persistence via Backdoor Service Account\",\n      \"tactic\": \"Persistence\",\n      \"description\": \"Attackers with sufficient permissions create new service accounts and grant them roles, to be used as a persistent backdoor into the GCP environment that is less likely to be noticed than a compromised user account.\",\n      \"gcp_relevance\": \"Creates a native GCP identity that can be used for long-term access to APIs, independent of user credentials which might be rotated or disabled.\",\n      \"priority\": \"HIGH\",\n      \"evidence\": [\n        \"Quote from CTI: 'Create new service accounts as backdoors'\"\n      ]\n    },\n    {\n      \"ttp_id\": \"\",\n      \"ttp_name\": \"Exfiltrate Data to External Cloud Storage\",\n      \"tactic\": \"Exfiltration\",\n      \"description\": \"Attackers use their elevated privileges to export large datasets from services like BigQuery into an attacker-controlled Cloud Storage bucket or download sensitive files directly from compromised buckets.\",\n      \"gcp_relevance\": \"Leverages GCP's high-speed internal networking and data management APIs to stage and steal large volumes of data efficiently.\",\n      \"priority\": \"HIGH\",\n      \"evidence\": [\n        \"Quote from CTI: 'Export BigQuery datasets to attacker-controlled Cloud Storage buckets'\",\n        \"Quote from CTI: 'Download sensitive files from Cloud Storage'\"\n      ]\n    },\n    {\n      \"ttp_id\": \"\",\n      \"ttp_name\": \"OS Password Reset on Compute Instance\",\n      \"tactic\": \"Privilege Escalation\",\n      \"description\": \"Attackers with cloud credentials (e.g., a service account with compute admin rights) reset the password for a user on a Compute Engine VM. This grants them direct OS-level access to the instance, bypassing other controls.\",\n      \"gcp_relevance\": \"This technique leverages cloud-level permissions to gain host-level control, bridging the gap between the control plane and the data plane. It's often used when direct SSH access isn't immediately possible.\",\n      \"priority\": \"HIGH\",\n      \"evidence\": [\n        \"Quote from CTI: 'OS password reset'\",\n        \"Quote from CTI: 'Attackers reset operating system passwords for compute instances... leveraging compromised cloud credentials to gain direct administrative access...'\"\n      ]\n    },\n    {\n      \"ttp_id\": \"\",\n      \"ttp_name\": \"Lateral Movement via Cross-Project IAM Grants\",\n      \"tactic\": \"Lateral Movement\",\n      \"description\": \"An attacker with sufficient privileges in one GCP project modifies IAM policies to grant their controlled principals (e.g., a service account) access to resources in other GCP projects within the same organization.\",\n      \"gcp_relevance\": \"This is a key technique for breaking out of an initial project-level compromise and spreading across a GCP organization, escalating the scope and impact of an attack.\",\n      \"priority\": \"HIGH\",\n      \"evidence\": [\n        \"Quote from CTI: 'Use elevated privileges to access other GCP projects'\",\n        \"Quote from CTI: 'Modify IAM policies to grant persistent access'\"\n      ]\n    },\n    {\n      \"ttp_id\": \"\",\n      \"ttp_name\": \"Account Discovery of Cloud Accounts\",\n      \"tactic\": \"Discovery\",\n      \"description\": \"Upon gaining initial access, attackers enumerate IAM policies and service accounts using CLI commands or API calls to understand the permission landscape and identify high-privilege targets for escalation.\",\n      \"gcp_relevance\": \"A foundational step in any GCP attack, using native tools like 'gcloud' to map out potential escalation paths and key targets within a project.\",\n      \"priority\": \"MEDIUM\",\n      \"evidence\": [\n        \"Quote from CTI: 'Enumerate IAM policies: `gcloud projects get-iam-policy`'\",\n        \"Quote from CTI: 'List service accounts: `gcloud iam service-accounts list`'\"\n      ]\n    },\n    {\n      \"ttp_id\": \"\",\n      \"ttp_name\": \"Resource Hijacking by Launching New Instances\",\n      \"tactic\": \"Impact\",\n      \"description\": \"Attackers use compromised credentials to provision new cloud resources, such as Compute Engine instances, within the victim's environment. These resources are then used for malicious purposes like cryptocurrency mining or establishing C2 infrastructure.\",\n      \"gcp_relevance\": \"This directly impacts the victim's billing and resource consumption. It's a common objective for financially motivated actors and can also serve as a platform for further attacks.\",\n      \"priority\": \"MEDIUM\",\n      \"evidence\": [\n        \"Quote from CTI: 'Launch new cloud resources'\",\n        \"Quote from CTI: 'potentially for staging further attacks, establishing C2 infrastructure, cryptocurrency mining, or expanding their operational footprint.'\"\n      ]\n    }\n  ],\n  \"gcp_services_targeted\": [\n    \"Cloud IAM\",\n    \"Compute Engine\",\n    \"Cloud Storage\",\n    \"BigQuery\",\n    \"Cloud Functions\",\n    \"VPC (Firewall Rules)\",\n    \"Cloud Logging\"\n  ],\n  \"key_indicators\": [\n    \"API call `iam.serviceAccounts.generateAccessToken` where `authenticationInfo.principalEmail` is a user account, not a service account.\",\n    \"API call `SetIamPolicy` that adds `roles/owner`, `roles/editor`, or `roles/iam.serviceAccountTokenCreator` to a suspicious principal.\",\n    \"Deletion of Compute Engine snapshots (`compute.snapshots.delete`).\",\n    \"Modification of instance metadata, particularly `startup-script` or `ssh-keys`.\",\n    \"Creation of new VPC firewall rules that allow ingress from `0.0.0.0/0` on sensitive ports.\",\n    \"Creation of new service accounts by non-administrator users or from unusual IP addresses.\",\n    \"Large data exports from BigQuery (`bigquery.datasets.export`) to buckets outside the organization.\",\n    \"OS-level password reset commands initiated via the GCP console or API.\",\n    \"Anomalous `gcloud projects get-iam-policy` or `gcloud iam service-accounts list` activity from a single user in a short timeframe.\"\n  ],\n  \"research_references\": [\n    \"https://cloud.google.com/iam/docs/impersonating-service-accounts\",\n    \"https://cloud.google.com/iam/docs/best-practices-for-using-service-accounts\",\n    \"https://cloud.google.com/logging/docs/audit\",\n    \"https://cloud.google.com/compute/docs/startupscript\",\n    \"https://cloud.google.com/compute/docs/instances/managing-ssh-keys\",\n    \"https://cloud.google.com/compute/docs/snapshots/delete-snapshots\",\n    \"https://cloud.google.com/vpc/docs/firewalls\",\n    \"https://attack.mitre.org/techniques/T1550/001/\",\n    \"https://attack.mitre.org/techniques/T1490/\",\n    \"https://attack.mitre.org/techniques/T1098/004/\"\n  ]\n}\"\"\"\n    ),\n  ],\n  role='model'\n), grounding_metadata=None, partial=None, turn_complete=None, finish_reason=<FinishReason.STOP: 'STOP'>, error_code=None, error_message=None, interrupted=None, custom_metadata=None, usage_metadata=GenerateContentResponseUsageMetadata(\n  candidates_token_count=3351,\n  candidates_tokens_details=[\n    ModalityTokenCount(\n      modality=<MediaModality.TEXT: 'TEXT'>,\n      token_count=3351\n    ),\n  ],\n  prompt_token_count=12316,\n  prompt_tokens_details=[\n    ModalityTokenCount(\n      modality=<MediaModality.TEXT: 'TEXT'>,\n      token_count=12316\n    ),\n  ],\n  thoughts_token_count=1834,\n  total_token_count=17501,\n  traffic_type=<TrafficType.ON_DEMAND: 'ON_DEMAND'>\n), live_session_resumption_update=None, input_transcription=None, output_transcription=None, avg_logprobs=-0.09635872016981871, logprobs_result=None, cache_metadata=None, citation_metadata=None, interaction_id=None, invocation_id='e-8e324ede-eb17-432c-a5f8-cd216bcec786', author='cti_analyzer', actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}, requested_tool_confirmations={}, compaction=None, end_of_agent=None, agent_state=None, rewind_before_invocation_id=None), long_running_tool_ids=None, branch=None, id='79e3c4a5-be42-4aba-8d7e-caa5e90da04a', timestamp=1770497517.959483)]",
  "ttp_mapping": "[Event(model_version='gemini-2.5-pro', content=Content(\n  parts=[\n    Part(\n      text=\"\"\"{\n  \"ttps\": [\n    {\n      \"ttp_id\": \"T1550.001\",\n      \"ttp_name\": \"Use Alternate Authentication Material: Application Access Token\",\n      \"tactic\": \"Privilege Escalation\",\n      \"description\": \"After compromising a principal with the 'iam.serviceAccountTokenCreator' role, attackers use the 'iam.serviceAccounts.generateAccessToken' API to mint short-lived credentials for a higher-privilege service account, allowing them to assume the identity of that account without needing its static key.\",\n      \"gcp_relevance\": \"This is a primary privilege escalation vector in GCP that allows attackers to bypass user-based controls like MFA. By impersonating a service account, they inherit its permissions. Detection relies on auditing 'GenerateAccessToken' API calls and flagging when the calling principal is a user account targeting a high-privilege service account.\",\n      \"priority\": \"HIGH\",\n      \"evidence\": [\n        \"Quote from CTI: 'Use `GenerateAccessToken` API to impersonate high-privilege service accounts'\",\n        \"Quote from CTI: 'Bypass MFA by using service account tokens instead of user accounts'\",\n        \"Quote from CTI: 'GCP API Calls Observed: iam.serviceAccounts.generateAccessToken'\"\n      ]\n    },\n    {\n      \"ttp_id\": \"T1098\",\n      \"ttp_name\": \"Account Manipulation\",\n      \"tactic\": \"Privilege Escalation\",\n      \"description\": \"Attackers with the 'resourcemanager.projects.setIamPolicy' permission modify a project's IAM policy to grant highly permissive roles, such as 'roles/owner' or 'roles/iam.serviceAccountTokenCreator', to an account they control. This provides them with unrestricted access or sets up future escalation.\",\n      \"gcp_relevance\": \"Direct modification of IAM policies via the 'SetIamPolicy' API is the most direct path to privilege escalation in GCP. A single API call can grant an attacker complete control. This is a high-impact event that is clearly visible in Cloud Audit Logs for the 'SetIamPolicy' method and should be monitored with high-priority alerts.\",\n      \"priority\": \"HIGH\",\n      \"evidence\": [\n        \"Quote from CTI: 'Binding modifications granting `roles/owner` to new principals'\",\n        \"Quote from CTI: '`SetIamPolicy` calls adding `roles/iam.serviceAccountTokenCreator`'\"\n      ]\n    },\n    {\n      \"ttp_id\": \"T1490\",\n      \"ttp_name\": \"Inhibit System Recovery\",\n      \"tactic\": \"Impact\",\n      \"description\": \"As part of a ransomware or destructive attack, adversaries delete snapshots of Compute Engine instances using the 'compute.snapshots.delete' API call. This prevents victims from restoring their systems from backups, increasing the pressure to pay a ransom.\",\n      \"gcp_relevance\": \"This technique directly targets GCP's native backup mechanism for Compute Engine VMs. Deleting snapshots can cause significant, often irreversible, data loss and operational disruption. Monitoring for 'compute.snapshots.delete' events, especially in bulk or by unusual principals, is critical for detecting this impact-focused activity.\",\n      \"priority\": \"HIGH\",\n      \"evidence\": [\n        \"Quote from CTI: 'Delete compute snapshot'\",\n        \"Quote from CTI: 'This action is characteristic of ransomware or destructive attacks, aimed at hindering the victim's ability to restore systems.'\"\n      ]\n    },\n    {\n      \"ttp_id\": \"T1578.003\",\n      \"ttp_name\": \"Modify Cloud Compute Infrastructure: Modify Cloud Instance Metadata\",\n      \"tactic\": \"Persistence\",\n      \"description\": \"Attackers modify the 'startup-script' metadata of a Compute Engine instance to execute malicious code every time the instance boots. This ensures their tools or backdoors are re-established automatically, providing durable, root-level persistence on the host.\",\n      \"gcp_relevance\": \"This is a powerful persistence mechanism on GCP compute instances. The 'startup-script' runs with root privileges and is managed via the 'compute.instances.setMetadata' API. Since this configuration is part of the cloud control plane, it often evades traditional host-based security monitoring, making it a stealthy persistence method.\",\n      \"priority\": \"HIGH\",\n      \"evidence\": [\n        \"Quote from CTI: 'Modify compute startup script'\",\n        \"Quote from CTI: 'Attackers alter the metadata of cloud compute instances (e.g., GCP Compute Engine startup scripts) to execute malicious commands'\"\n      ]\n    },\n    {\n      \"ttp_id\": \"T1098.004\",\n      \"ttp_name\": \"Account Manipulation: Additional Cloud Credentials\",\n      \"tactic\": \"Persistence\",\n      \"description\": \"Adversaries add their own public SSH keys to the metadata of a Compute Engine instance or an entire project. This grants them persistent remote access to the virtual machines as the specified user, creating a durable backdoor.\",\n      \"gcp_relevance\": \"GCP provides a centralized mechanism for managing SSH keys via metadata. Attackers abuse this by calling 'compute.instances.setMetadata' or 'compute.projects.setCommonInstanceMetadata' to inject their key into the 'ssh-keys' metadata value. This allows them to bypass firewall restrictions and gain direct, persistent access to instances.\",\n      \"priority\": \"HIGH\",\n      \"evidence\": [\n        \"Quote from CTI: 'Create SSH backdoor'\",\n        \"Quote from CTI: 'attackers establish persistent, unauthorized SSH access to compute instances, typically by adding their own public keys'\"\n      ]\n    },\n    {\n      \"ttp_id\": \"T1562.007\",\n      \"ttp_name\": \"Impair Defenses: Disable or Modify Cloud Firewall\",\n      \"tactic\": \"Defense Evasion\",\n      \"description\": \"Attackers create or modify GCP Firewall Rules to allow inbound or outbound traffic for C2 communication or data exfiltration. This undermines the established network security posture and bypasses segmentation controls.\",\n      \"gcp_relevance\": \"GCP VPC Firewall Rules are a fundamental security control. Attackers use APIs like 'compute.firewalls.insert' or 'compute.firewalls.patch' to open ports (e.g., allowing ingress from 0.0.0.0/0). These changes are clearly logged in audit logs and represent a significant weakening of the environment's defenses.\",\n      \"priority\": \"HIGH\",\n      \"evidence\": [\n        \"Quote from CTI: 'Create or modify firewall or security group rules'\",\n        \"Quote from CTI: 'permit unauthorized inbound/outbound traffic, facilitating C2, lateral movement, or data exfiltration'\"\n      ]\n    },\n    {\n      \"ttp_id\": \"T1136.003\",\n      \"ttp_name\": \"Create Account: Cloud Account\",\n      \"tactic\": \"Persistence\",\n      \"description\": \"Attackers create new service accounts and grant them specific IAM roles to use as a persistent backdoor. These accounts are often overlooked during incident response compared to compromised user accounts.\",\n      \"gcp_relevance\": \"Creating a service account via 'iam.serviceAccounts.create' establishes a new, independent identity within the GCP project. This non-human account can then be used to authenticate to GCP APIs for long-term access, making it a stealthy and effective persistence mechanism that is decoupled from user lifecycle management.\",\n      \"priority\": \"HIGH\",\n      \"evidence\": [\n        \"Quote from CTI: 'Create new service accounts as backdoors'\"\n      ]\n    },\n    {\n      \"ttp_id\": \"T1537\",\n      \"ttp_name\": \"Transfer Data to Cloud Account\",\n      \"tactic\": \"Exfiltration\",\n      \"description\": \"Attackers exfiltrate data by transferring it to a cloud account under their control. This is often done by exporting data from a service like BigQuery into an external, attacker-owned Cloud Storage bucket.\",\n      \"gcp_relevance\": \"This technique leverages GCP's high-speed internal networking to efficiently steal large volumes of data. A BigQuery extract job or a 'gsutil' copy command can transfer terabytes of data to an external bucket quickly. Detecting this requires monitoring for data transfers to storage buckets outside of the organization's known projects or defined perimeter.\",\n      \"priority\": \"HIGH\",\n      \"evidence\": [\n        \"Quote from CTI: 'Export BigQuery datasets to attacker-controlled Cloud Storage buckets'\",\n        \"Quote from CTI: 'Download sensitive files from Cloud Storage'\"\n      ]\n    },\n    {\n      \"ttp_id\": \"T1098\",\n      \"ttp_name\": \"Account Manipulation\",\n      \"tactic\": \"Privilege Escalation\",\n      \"description\": \"An attacker with cloud-level permissions, such as Compute Admin, resets the password for a local user on a Compute Engine virtual machine. This leverages control plane access to gain data plane (OS-level) access.\",\n      \"gcp_relevance\": \"This technique bridges the gap between cloud and host control by using GCP APIs to manipulate OS-level accounts. It's a powerful pivot for an attacker with control plane access (e.g., a compromised service account) to gain interactive shell access on a compute instance without prior host credentials.\",\n      \"priority\": \"HIGH\",\n      \"evidence\": [\n        \"Quote from CTI: 'OS password reset'\",\n        \"Quote from CTI: 'Attackers reset operating system passwords for compute instances... leveraging compromised cloud credentials to gain direct administrative access...'\"\n      ]\n    },\n    {\n      \"ttp_id\": \"T1078.004\",\n      \"ttp_name\": \"Valid Accounts: Cloud Accounts\",\n      \"tactic\": \"Lateral Movement\",\n      \"description\": \"An attacker uses a compromised account with sufficient permissions in one GCP project to grant their controlled principals access to other projects within the same organization, expanding their foothold.\",\n      \"gcp_relevance\": \"In GCP, permissions can be set at the organization or folder level and inherited by child projects. An attacker who compromises a principal with 'SetIamPolicy' permissions at a high level can grant their own accounts roles on other projects, enabling lateral movement across the cloud environment.\",\n      \"priority\": \"HIGH\",\n      \"evidence\": [\n        \"Quote from CTI: 'Use elevated privileges to access other GCP projects'\",\n        \"Quote from CTI: 'Modify IAM policies to grant persistent access'\"\n      ]\n    },\n    {\n      \"ttp_id\": \"T1087.004\",\n      \"ttp_name\": \"Account Discovery: Cloud Account\",\n      \"tactic\": \"Discovery\",\n      \"description\": \"Upon gaining initial access, attackers enumerate IAM policies and service accounts using CLI commands ('gcloud') or direct API calls to map the permission landscape and identify high-privilege targets for escalation.\",\n      \"gcp_relevance\": \"This is a foundational reconnaissance step in a GCP attack. Using native APIs like 'cloudresourcemanager.projects.getIamPolicy' and 'iam.projects.serviceAccounts.list', attackers identify principals, roles, and potential privilege escalation paths. While noisy, anomalous patterns of this activity can be a key early indicator.\",\n      \"priority\": \"MEDIUM\",\n      \"evidence\": [\n        \"Quote from CTI: 'Enumerate IAM policies: `gcloud projects get-iam-policy`'\",\n        \"Quote from CTI: 'List service accounts: `gcloud iam service-accounts list`'\"\n      ]\n    },\n    {\n      \"ttp_id\": \"T1496\",\n      \"ttp_name\": \"Resource Hijacking\",\n      \"tactic\": \"Impact\",\n      \"description\": \"Attackers use compromised credentials to provision new Compute Engine instances within the victim's environment for malicious purposes, such as cryptocurrency mining, C2 infrastructure, or staging for further attacks.\",\n      \"gcp_relevance\": \"This abuse directly impacts the victim through increased billing costs and consumption of resource quotas. The 'compute.instances.insert' API call is used to create these unauthorized resources. Detection involves monitoring for anomalous instance creation, such as VMs being spun up in unusual regions or by principals that do not normally provision infrastructure.\",\n      \"priority\": \"MEDIUM\",\n      \"evidence\": [\n        \"Quote from CTI: 'Launch new cloud resources'\",\n        \"Quote from CTI: 'potentially for staging further attacks, establishing C2 infrastructure, cryptocurrency mining, or expanding their operational footprint.'\"\n      ]\n    }\n  ],\n  \"total_ttps\": 12\n}\"\"\"\n    ),\n  ],\n  role='model'\n), grounding_metadata=None, partial=None, turn_complete=None, finish_reason=<FinishReason.STOP: 'STOP'>, error_code=None, error_message=None, interrupted=None, custom_metadata=None, usage_metadata=GenerateContentResponseUsageMetadata(\n  candidates_token_count=2782,\n  candidates_tokens_details=[\n    ModalityTokenCount(\n      modality=<MediaModality.TEXT: 'TEXT'>,\n      token_count=2782\n    ),\n  ],\n  prompt_token_count=13116,\n  prompt_tokens_details=[\n    ModalityTokenCount(\n      modality=<MediaModality.TEXT: 'TEXT'>,\n      token_count=13116\n    ),\n  ],\n  thoughts_token_count=2109,\n  total_token_count=18007,\n  traffic_type=<TrafficType.ON_DEMAND: 'ON_DEMAND'>\n), live_session_resumption_update=None, input_transcription=None, output_transcription=None, avg_logprobs=-0.23859612295560748, logprobs_result=None, cache_metadata=None, citation_metadata=None, interaction_id=None, invocation_id='e-c417bad7-4ec4-43cb-b8d3-fa5338eef78c', author='ttp_mapper', actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}, requested_tool_confirmations={}, compaction=None, end_of_agent=None, agent_state=None, rewind_before_invocation_id=None), long_running_tool_ids=None, branch=None, id='f66680b7-eadf-4649-abd9-90aaa7b633fd', timestamp=1770497606.60423)]",
  "sigma_rules": "[Event(model_version='gemini-2.5-pro', content=Content(\n  parts=[\n    Part(\n      text=\"\"\"{\n  \"rules\": [\n    {\n      \"title\": \"GCP Service Account Impersonation by Non-SA Principal\",\n      \"id\": \"c6a218d8-7b9e-4c3e-8f1b-9a7c6d5e4f3a\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects when a non-service account principal, such as a user account, generates an access token for a service account. This is a primary method for privilege escalation (T1550.001) where an attacker with 'iam.serviceAccountTokenCreator' permissions can impersonate a higher-privilege service account to inherit its permissions, often bypassing user-based controls like MFA.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1550/001/\",\n        \"https://cloud.google.com/iam/docs/impersonating-service-accounts\",\n        \"https://cloud.google.com/iam/docs/reference/credentials/rest/v1/projects.serviceAccounts/generateAccessToken\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-31\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.privilege_escalation\",\n        \"attack.credential_access\",\n        \"attack.t1550.001\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.serviceName\": [\n            \"iam.googleapis.com\",\n            \"iamcredentials.googleapis.com\"\n          ],\n          \"protoPayload.methodName\": [\n            \"GenerateAccessToken\",\n            \"google.iam.credentials.v1.IAMCredentials.GenerateAccessToken\"\n          ],\n          \"resource.type\": \"service_account\",\n          \"protoPayload.status.code\": 0\n        },\n        \"filter_legitimate\": {\n          \"protoPayload.authenticationInfo.principalEmail|endswith\": \".gserviceaccount.com\"\n        },\n        \"condition\": \"selection and not filter_legitimate\"\n      },\n      \"falsepositives\": [\n        \"Legitimate break-glass procedures where an administrator manually impersonates a service account for emergency access.\",\n        \"CI/CD pipelines or infrastructure-as-code tools that are configured to use user credentials instead of a dedicated service account (a non-recommended practice).\"\n      ],\n      \"level\": \"high\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"protoPayload.request.name\",\n        \"resource.labels.project_id\",\n        \"timestamp\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"An attacker with a compromised user account 'attacker@example.com' runs `gcloud iam service-accounts generate-access-token admin-sa@project.iam.gserviceaccount.com` to escalate privileges.\",\n        \"false_negative\": \"An attacker uses a compromised service account to impersonate another service account. This rule would not trigger as the filter condition would match.\",\n        \"false_positive\": \"A site reliability engineer 'sre@example.com' follows a documented break-glass runbook to impersonate a service account to fix a production issue.\",\n        \"true_negative\": \"A GKE node's service account authenticates to another GCP service, which involves token generation between service accounts.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit#audit_log_entry_structure\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"google.iam.credentials.v1.IAMCredentials.GenerateAccessToken\",\n          \"protoPayload.serviceName\": \"iamcredentials.googleapis.com\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"attacker@evil.com\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP IAM Policy Changed to Grant Highly Privileged Role\",\n      \"id\": \"d1e2f3a4-b5c6-4d7e-8f9b-0c1d2e3f4a5b\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects when a GCP IAM policy is modified to grant a highly permissive role (e.g., Owner, Editor, Service Account Token Creator) to a principal. This action provides broad access and is a critical privilege escalation technique (T1098).\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1098/\",\n        \"https://cloud.google.com/iam/docs/understanding-roles\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-31\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.privilege_escalation\",\n        \"attack.t1098\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.serviceName\": \"cloudresourcemanager.googleapis.com\",\n          \"protoPayload.methodName\": \"SetIamPolicy\",\n          \"protoPayload.request.policy.bindings.role\": [\n            \"roles/owner\",\n            \"roles/editor\",\n            \"roles/iam.serviceAccountTokenCreator\"\n          ],\n          \"protoPayload.status.code\": 0\n        },\n        \"filter_legitimate\": {\n          \"protoPayload.authenticationInfo.principalEmail\": [\n            \"org-admin@company.com\",\n            \"terraform-prod@project.iam.gserviceaccount.com\"\n          ]\n        },\n        \"condition\": \"selection and not filter_legitimate\"\n      },\n      \"falsepositives\": [\n        \"Initial project setup by authorized organization administrators or infrastructure-as-code (IaC) service accounts.\",\n        \"Approved break-glass procedures for emergency project access.\"\n      ],\n      \"level\": \"critical\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"protoPayload.request.policy.bindings.members\",\n        \"protoPayload.request.policy.bindings.role\",\n        \"resource.labels.project_id\",\n        \"timestamp\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"A compromised developer account with 'resourcemanager.projects.setIamPolicy' permission adds an external attacker account with the 'roles/owner' role on the project.\",\n        \"false_negative\": \"An attacker grants a custom role with permissions equivalent to 'owner' (e.g., '*') instead of one of the specified predefined roles.\",\n        \"false_positive\": \"An authorized Terraform service account assigns a project owner during the automated creation of a new GCP project.\",\n        \"true_negative\": \"An administrator grants a user the 'roles/viewer' role on a project.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit#audit_log_entry_structure\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"SetIamPolicy\",\n          \"protoPayload.request.policy.bindings.role\": \"roles/owner\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"compromised-user@example.com\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP Compute Engine Snapshot Deleted\",\n      \"id\": \"e3f4a5b6-c7d8-4b9c-8d1e-2f3a4b5c6d7e\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects the deletion of a Compute Engine disk snapshot. Attackers may delete snapshots to inhibit system recovery (T1490) as part of a ransomware or destructive attack. This activity is often noisy; it is best to correlate with other suspicious events or tune for high-volume deletions from a single principal.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1490/\",\n        \"https://cloud.google.com/compute/docs/disks/create-snapshots\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-31\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.impact\",\n        \"attack.t1490\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.serviceName\": \"compute.googleapis.com\",\n          \"protoPayload.methodName\": \"v1.compute.snapshots.delete\",\n          \"protoPayload.status.code\": 0\n        },\n        \"filter_legitimate\": {\n          \"protoPayload.authenticationInfo.principalEmail|endswith\": [\n            \"@gcp-sa-cloud-storage-transfer.iam.gserviceaccount.com\",\n            \"-compute@developer.gserviceaccount.com\"\n          ]\n        },\n        \"condition\": \"selection and not filter_legitimate\"\n      },\n      \"falsepositives\": [\n        \"Automated backup lifecycle management scripts or tools deleting old or expired snapshots.\",\n        \"Manual cleanup of test or development snapshots by engineers.\"\n      ],\n      \"level\": \"high\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"resource.labels.project_id\",\n        \"protoPayload.resourceName\",\n        \"timestamp\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"A compromised account executes a script to loop through and delete all available disk snapshots in a project.\",\n        \"false_negative\": \"An attacker removes the IAM policy that grants access to the snapshots, effectively making them inaccessible without deleting them.\",\n        \"false_positive\": \"A daily scheduled job running as a service account deletes snapshots older than 30 days as per the defined retention policy.\",\n        \"true_negative\": \"A new snapshot is created as part of a daily backup process.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit#audit_log_entry_structure\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"v1.compute.snapshots.delete\",\n          \"protoPayload.serviceName\": \"compute.googleapis.com\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"attacker@evil.com\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP Compute Instance Startup Script Modified\",\n      \"id\": \"f5a6b7c8-d9e0-4c1d-8e2f-3a4b5c6d7e8f\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects modification of the 'startup-script' or 'startup-script-url' metadata on a Compute Engine instance. Attackers use this (T1578.003) to establish persistence, as the script runs with root privileges each time the instance boots, allowing them to execute malicious code.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1578/003/\",\n        \"https://cloud.google.com/compute/docs/instances/startup-scripts/setting-startup-script\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-31\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.persistence\",\n        \"attack.t1578.003\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.serviceName\": \"compute.googleapis.com\",\n          \"protoPayload.methodName\": \"v1.compute.instances.setMetadata\",\n          \"protoPayload.request.metadata.items.key\": [\n            \"startup-script\",\n            \"startup-script-url\"\n          ],\n          \"protoPayload.status.code\": 0\n        },\n        \"filter_legitimate\": {\n          \"protoPayload.authenticationInfo.principalEmail|endswith\": [\n            \"@cloudservices.gserviceaccount.com\",\n            \"terraform@my-project.iam.gserviceaccount.com\"\n          ]\n        },\n        \"condition\": \"selection and not filter_legitimate\"\n      },\n      \"falsepositives\": [\n        \"Legitimate updates to instance startup scripts by administrators or configuration management tools (e.g., Ansible, Terraform) to install or update software.\",\n        \"Google Cloud Platform services updating metadata on managed instance groups.\"\n      ],\n      \"level\": \"high\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"protoPayload.resourceName\",\n        \"resource.labels.project_id\",\n        \"timestamp\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"An attacker modifies the 'startup-script-url' of a web server to point to a malicious script hosted in a public bucket.\",\n        \"false_negative\": \"An attacker modifies the 'shutdown-script' metadata instead, which executes on instance shutdown.\",\n        \"false_positive\": \"A system administrator updates the startup script via the console to install a new security agent on a VM.\",\n        \"true_negative\": \"A user modifies a different metadata key, such as 'serial-port-enable', on an instance.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit#audit_log_entry_structure\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"v1.compute.instances.setMetadata\",\n          \"protoPayload.request.metadata.items.key\": \"startup-script-url\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"compromised-user@example.com\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP SSH Key Added to Instance or Project Metadata\",\n      \"id\": \"a7b8c9d0-e1f2-4d3e-8f4a-5b6c7d8e9f0a\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects when SSH keys are added to the metadata of a Compute Engine instance or an entire project. Attackers use this (T1098.004) to create a persistent SSH backdoor, bypassing firewalls and other access controls.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1098/004/\",\n        \"https://cloud.google.com/compute/docs/instances/managing-instance-access\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-31\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.persistence\",\n        \"attack.t1098.004\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.serviceName\": \"compute.googleapis.com\",\n          \"protoPayload.methodName\": [\n            \"v1.compute.instances.setMetadata\",\n            \"v1.compute.projects.setCommonInstanceMetadata\",\n            \"beta.compute.projects.setCommonInstanceMetadata\"\n          ],\n          \"protoPayload.request.metadata.items.key\": [\n            \"ssh-keys\",\n            \"sshKeys\"\n          ],\n          \"protoPayload.status.code\": 0\n        },\n        \"filter_legitimate\": {\n          \"protoPayload.authenticationInfo.principalEmail\": \"google-oslogin@google.com\"\n        },\n        \"condition\": \"selection and not filter_legitimate\"\n      },\n      \"falsepositives\": [\n        \"Administrators legitimately adding SSH keys for new developers or for their own access.\",\n        \"Automated onboarding scripts that add user SSH keys to projects.\",\n        \"The OS Login service managing SSH keys, which may use a dedicated service account.\"\n      ],\n      \"level\": \"high\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"protoPayload.resourceName\",\n        \"protoPayload.methodName\",\n        \"resource.labels.project_id\",\n        \"timestamp\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"An attacker uses a compromised account to call 'compute.projects.setCommonInstanceMetadata' and inject their public SSH key into the 'ssh-keys' value for all VMs in the project.\",\n        \"false_negative\": \"An attacker gains OS-level access and adds their key directly to the '~/.ssh/authorized_keys' file on the instance, bypassing the GCP metadata API.\",\n        \"false_positive\": \"An engineering manager adds a new team member's public SSH key to a project's metadata to grant them access.\",\n        \"true_negative\": \"A user modifies the 'startup-script' metadata key.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit#audit_log_entry_structure\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"v1.compute.projects.setCommonInstanceMetadata\",\n          \"protoPayload.request.metadata.items.key\": \"ssh-keys\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"attacker@evil.com\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP Firewall Rule Allowing Unrestricted Ingress Created\",\n      \"id\": \"b9c0d1e2-f3a4-4e5f-8a6b-7c8d9e0f1a2b\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects the creation or modification of a GCP Firewall Rule that allows inbound traffic from any source (IPv4 '0.0.0.0/0' or IPv6 '::/0'). Attackers use this (T1562.007) to open ports for C2 communication or to expose internal services.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1562/007/\",\n        \"https://cloud.google.com/vpc/docs/firewalls\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-31\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.defense_evasion\",\n        \"attack.t1562.007\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.serviceName\": \"compute.googleapis.com\",\n          \"protoPayload.methodName|startswith\": \"v1.compute.firewalls.\",\n          \"protoPayload.request.sourceRanges\": [\n            \"0.0.0.0/0\",\n            \"::/0\"\n          ],\n          \"protoPayload.status.code\": 0\n        },\n        \"filter_legitimate\": {\n          \"protoPayload.request.allowed.IPProtocol\": \"tcp\",\n          \"protoPayload.request.allowed.ports\": [\n            \"80\",\n            \"443\"\n          ]\n        },\n        \"condition\": \"selection and not filter_legitimate\"\n      },\n      \"falsepositives\": [\n        \"Legitimate creation of firewall rules to expose public web servers (HTTP/HTTPS) to the internet.\"\n      ],\n      \"level\": \"high\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"protoPayload.resourceName\",\n        \"protoPayload.request.allowed.IPProtocol\",\n        \"protoPayload.request.allowed.ports\",\n        \"resource.labels.project_id\",\n        \"timestamp\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"An attacker creates a new firewall rule named 'allow-rdp' that permits TCP traffic on port 3389 from '0.0.0.0/0'.\",\n        \"false_negative\": \"An attacker creates a rule allowing traffic from a very wide, but not universal, CIDR range like '0.0.0.0/1'.\",\n        \"false_positive\": \"A network administrator creates a firewall rule to allow HTTPS (port 443) traffic from '0.0.0.0/0' to a new set of web servers.\",\n        \"true_negative\": \"An administrator creates a firewall rule to allow traffic between two internal subnets.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit#audit_log_entry_structure\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"v1.compute.firewalls.insert\",\n          \"protoPayload.request.sourceRanges\": \"0.0.0.0/0\",\n          \"protoPayload.request.allowed.ports\": \"3389\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP Service Account Created\",\n      \"id\": \"c1d2e3f4-a5b6-4f7a-8b9c-0d1e2f3a4b5c\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects the creation of a new service account (T1136.003). Attackers create new service accounts to use as a persistent backdoor, as they are non-human identities that are often less scrutinized than user accounts.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1136/003/\",\n        \"https://cloud.google.com/iam/docs/creating-managing-service-accounts\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-31\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.persistence\",\n        \"attack.t1136.003\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.serviceName\": \"iam.googleapis.com\",\n          \"protoPayload.methodName\": \"google.iam.admin.v1.CreateServiceAccount\",\n          \"protoPayload.status.code\": 0\n        },\n        \"filter_legitimate\": {\n          \"protoPayload.authenticationInfo.principalEmail|endswith\": [\n            \"-compute@developer.gserviceaccount.com\",\n            \"terraform-prod@my-project.iam.gserviceaccount.com\"\n          ]\n        },\n        \"condition\": \"selection and not filter_legitimate\"\n      },\n      \"falsepositives\": [\n        \"Legitimate creation of service accounts for new applications or resources by administrators.\",\n        \"Automated infrastructure-as-code (IaC) tools like Terraform provisioning new service accounts as part of a deployment.\"\n      ],\n      \"level\": \"low\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"protoPayload.request.accountId\",\n        \"protoPayload.response.email\",\n        \"resource.labels.project_id\",\n        \"timestamp\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"An attacker, having compromised a developer account, creates a new service account named 'gcp-billing-sync' to blend in and use as a backdoor.\",\n        \"false_negative\": \"An attacker compromises and re-uses an existing, dormant service account instead of creating a new one.\",\n        \"false_positive\": \"Terraform runs and creates a new service account for a new application as defined in its configuration files.\",\n        \"true_negative\": \"An administrator lists the existing service accounts in a project.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit#audit_log_entry_structure\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"google.iam.admin.v1.CreateServiceAccount\",\n          \"protoPayload.request.accountId\": \"backdoor-sa\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"compromised-user@example.com\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP BigQuery Data Extraction Job Initiated\",\n      \"id\": \"d3e4f5a6-b7c8-4a9b-8c1d-2e3f4a5b6c7d\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects a BigQuery extract job being initiated. Attackers use this (T1537) to exfiltrate large amounts of data by exporting tables to a Cloud Storage bucket. All exports should be investigated to ensure the destination bucket is an authorized location.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1537/\",\n        \"https://cloud.google.com/bigquery/docs/exporting-data\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-31\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.exfiltration\",\n        \"attack.t1537\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.serviceName\": \"bigquery.googleapis.com\",\n          \"protoPayload.methodName\": \"jobservice.insert\",\n          \"protoPayload.request.job.jobConfiguration.extract.destinationUris|contains\": \"gs://\",\n          \"protoPayload.status.code\": 0\n        },\n        \"filter_legitimate\": {\n          \"protoPayload.request.job.jobConfiguration.extract.destinationUris|startswith\": \"gs://internal-backup-bucket-\"\n        },\n        \"condition\": \"selection and not filter_legitimate\"\n      },\n      \"falsepositives\": [\n        \"Scheduled jobs that export data to legitimate, known internal or partner Cloud Storage buckets.\",\n        \"Data analysts creating backups or exporting sanitized data for local analysis.\",\n        \"This rule should be tuned by adding all legitimate destination bucket prefixes to the filter condition.\"\n      ],\n      \"level\": \"medium\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"protoPayload.request.job.jobConfiguration.extract.sourceTable.tableId\",\n        \"protoPayload.request.job.jobConfiguration.extract.destinationUris\",\n        \"resource.labels.project_id\",\n        \"timestamp\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"An attacker initiates a BigQuery extract job to copy the 'users' table to an external bucket 'gs://attacker-owned-bucket/data.csv'.\",\n        \"false_negative\": \"An attacker exfiltrates data by repeatedly using the 'tabledata.list' API, which avoids a single large export job.\",\n        \"false_positive\": \"An automated ETL process exports daily transaction data to a Cloud Storage bucket named 'gs://internal-backup-bucket-daily/'.\",\n        \"true_negative\": \"A data scientist runs a complex `SELECT` query in the BigQuery UI, which also creates a 'jobservice.insert' event but without an 'extract' configuration.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit#audit_log_entry_structure\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"jobservice.insert\",\n          \"protoPayload.serviceName\": \"bigquery.googleapis.com\",\n          \"protoPayload.request.job.jobConfiguration.extract.destinationUris\": \"gs://attacker-public-bucket/export.json\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP Windows Instance Password Created or Reset\",\n      \"id\": \"e5f6a7b8-c9d0-4b1c-8d2e-3f4a5b6c7d8e\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects the creation or reset of a Windows user password on a Compute Engine instance via the GCP metadata API. This technique (T1098) allows an attacker with cloud permissions to gain OS-level access.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1098/\",\n        \"https://cloud.google.com/compute/docs/instances/reset-windows-password\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-31\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.privilege_escalation\",\n        \"attack.t1098\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.serviceName\": \"compute.googleapis.com\",\n          \"protoPayload.methodName\": \"v1.compute.instances.setMetadata\",\n          \"protoPayload.request.metadata.items.key\": \"windows-keys\",\n          \"protoPayload.status.code\": 0\n        },\n        \"filter_legitimate\": null,\n        \"condition\": \"selection\"\n      },\n      \"falsepositives\": [\n        \"A system administrator legitimately using the 'reset-windows-password' gcloud command or console feature to regain access to a VM.\",\n        \"Automated account recovery processes that leverage this mechanism.\"\n      ],\n      \"level\": \"high\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"protoPayload.resourceName\",\n        \"resource.labels.project_id\",\n        \"timestamp\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"An attacker with Compute Admin rights uses `gcloud compute reset-windows-password` to create a new user and password for a domain controller VM.\",\n        \"false_negative\": \"An attacker uses a startup script to reset a local user password on a Linux VM, which would not involve the 'windows-keys' metadata key.\",\n        \"false_positive\": \"A help desk technician follows a standard procedure to reset a user's password on their Windows workstation VM.\",\n        \"true_negative\": \"An administrator reboots a Windows VM using the `v1.compute.instances.stop` and `v1.compute.instances.start` API calls.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit#audit_log_entry_structure\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"v1.compute.instances.setMetadata\",\n          \"protoPayload.request.metadata.items.key\": \"windows-keys\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"attacker-sa@project.iam.gserviceaccount.com\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP IAM Policy Modified at Org or Folder Level\",\n      \"id\": \"f7a8b9c0-d1e2-4c3d-8e4f-5a6b7c8d9e0f\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects modifications to IAM policies at the Organization or Folder level. Changes at this level are high-impact and can be used for widespread lateral movement (T1078.004) by granting an attacker's account permissions across multiple projects.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1078/004/\",\n        \"https://cloud.google.com/resource-manager/docs/access-control-org\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-31\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.lateral_movement\",\n        \"attack.privilege_escalation\",\n        \"attack.t1078.004\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.serviceName\": \"cloudresourcemanager.googleapis.com\",\n          \"protoPayload.methodName\": \"SetIamPolicy\",\n          \"resource.type\": [\n            \"organization\",\n            \"folder\"\n          ],\n          \"protoPayload.status.code\": 0\n        },\n        \"filter_legitimate\": {\n          \"protoPayload.authenticationInfo.principalEmail\": [\n            \"org-admin-group@example.com\",\n            \"central-iac@my-org.iam.gserviceaccount.com\"\n          ]\n        },\n        \"condition\": \"selection and not filter_legitimate\"\n      },\n      \"falsepositives\": [\n        \"Authorized Organization Administrators or central IaC service accounts deploying new organization-wide security policies or role bindings.\"\n      ],\n      \"level\": \"critical\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"protoPayload.request.policy.bindings.role\",\n        \"protoPayload.request.policy.bindings.members\",\n        \"resource.type\",\n        \"resource.labels.folder_id\",\n        \"resource.labels.organization_id\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"An attacker who compromised a Folder Admin account adds their external account as 'Folder Owner', gaining control over all projects within that folder.\",\n        \"false_negative\": \"An attacker moves laterally between two projects without modifying Folder or Organization level policies.\",\n        \"false_positive\": \"A central security team, using an approved service account, applies a new custom role binding to all projects by setting the IAM policy at the organization level.\",\n        \"true_negative\": \"A project administrator grants a developer 'roles/viewer' on a single project.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit#audit_log_entry_structure\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"SetIamPolicy\",\n          \"resource.type\": \"folder\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"compromised-folder-admin@example.com\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP Project-Level IAM Policy Discovery\",\n      \"id\": \"a9b0c1d2-e3f4-4d5e-8f6a-7b8c9d0e1f2a\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects the use of 'GetIamPolicy' at a project level. This is a foundational discovery technique (T1087.004) used by attackers to map the permission landscape, identify principals and roles, and find potential privilege escalation paths.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1087/004/\",\n        \"https://cloud.google.com/iam/docs/reference/rest/v1/projects/getIamPolicy\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-31\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.discovery\",\n        \"attack.t1087.004\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.serviceName\": \"cloudresourcemanager.googleapis.com\",\n          \"protoPayload.methodName\": \"GetIamPolicy\"\n        },\n        \"filter_legitimate\": {\n          \"protoPayload.authenticationInfo.principalEmail|endswith\": [\n            \"@cloudservices.gserviceaccount.com\",\n            \"-compute@developer.gserviceaccount.com\",\n            \"@gcp-sa-config-connector.iam.gserviceaccount.com\"\n          ]\n        },\n        \"condition\": \"selection and not filter_legitimate\"\n      },\n      \"falsepositives\": [\n        \"Security scanners, compliance tools, or audit scripts enumerating permissions across projects.\",\n        \"Administrators or developers checking permissions while troubleshooting.\",\n        \"GCP-internal services performing checks.\"\n      ],\n      \"level\": \"informational\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"resource.labels.project_id\",\n        \"timestamp\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"An attacker runs `gcloud projects get-iam-policy <project-id>` after gaining initial access to understand who has what permissions.\",\n        \"false_negative\": \"An attacker uses the `gcloud asset search-all-iam-policies` command, which uses a different API and might not be caught by this rule.\",\n        \"false_positive\": \"A security engineer runs a script that iterates through all projects and calls `get-iam-policy` on each one to generate a permissions report.\",\n        \"true_negative\": \"A user gets the IAM policy for a single Cloud Storage bucket, which uses a different serviceName.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit#audit_log_entry_structure\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"GetIamPolicy\",\n          \"protoPayload.serviceName\": \"cloudresourcemanager.googleapis.com\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"attacker@evil.com\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP Service Account Discovery\",\n      \"id\": \"b1c2d3e4-f5a6-4e7f-8b9c-0d1e2f3a4b5c\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects the listing of service accounts in a project. This is a common discovery technique (T1087.004) used by attackers after initial access to identify high-privilege service accounts for impersonation or targeting.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1087/004/\",\n        \"https://cloud.google.com/iam/docs/reference/rest/v1/projects.serviceAccounts/list\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-31\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.discovery\",\n        \"attack.t1087.004\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.serviceName\": \"iam.googleapis.com\",\n          \"protoPayload.methodName\": \"google.iam.admin.v1.ListServiceAccounts\"\n        },\n        \"filter_legitimate\": {\n          \"protoPayload.authenticationInfo.principalEmail|endswith\": [\n            \"@cloudservices.gserviceaccount.com\",\n            \"-compute@developer.gserviceaccount.com\"\n          ]\n        },\n        \"condition\": \"selection and not filter_legitimate\"\n      },\n      \"falsepositives\": [\n        \"Security scanners or compliance scripts enumerating service accounts.\",\n        \"Administrators using the GCP console or gcloud CLI to view service accounts.\"\n      ],\n      \"level\": \"informational\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"resource.labels.project_id\",\n        \"timestamp\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"An attacker runs `gcloud iam service-accounts list` to find potential target accounts for impersonation.\",\n        \"false_negative\": \"An attacker obtains a list of service accounts through an out-of-band method, such as from public code repositories.\",\n        \"false_positive\": \"A developer lists the service accounts in their project to find the correct one for an application.\",\n        \"true_negative\": \"An administrator creates a new service account.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit#audit_log_entry_structure\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"google.iam.admin.v1.ListServiceAccounts\",\n          \"protoPayload.serviceName\": \"iam.googleapis.com\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"attacker@evil.com\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP Compute Instance Created By Non-Service Account\",\n      \"id\": \"c3d4e5f6-a7b8-4f9a-8b1c-2d3e4f5a6b7c\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects the creation of a Compute Engine instance by a principal that is not a service account. In automated environments, infrastructure is typically provisioned by IaC tools using service accounts. Manual creation by a user can indicate resource hijacking (T1496) for purposes like cryptomining.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1496/\",\n        \"https://cloud.google.com/compute/docs/reference/rest/v1/instances/insert\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-31\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.impact\",\n        \"attack.t1496\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.serviceName\": \"compute.googleapis.com\",\n          \"protoPayload.methodName\": \"v1.compute.instances.insert\",\n          \"protoPayload.status.code\": 0\n        },\n        \"filter_legitimate\": {\n          \"protoPayload.authenticationInfo.principalEmail|endswith\": \".gserviceaccount.com\"\n        },\n        \"condition\": \"selection and not filter_legitimate\"\n      },\n      \"falsepositives\": [\n        \"Engineers or developers manually creating VMs for testing or debugging in development projects.\",\n        \"Administrators creating a one-off instance for a specific purpose.\"\n      ],\n      \"level\": \"medium\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"protoPayload.resourceName\",\n        \"resource.labels.project_id\",\n        \"protoPayload.request.machineType\",\n        \"protoPayload.request.disks.initializeParams.sourceImage\",\n        \"timestamp\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"An attacker with compromised user credentials manually creates 100 small compute instances to use for a botnet or cryptomining.\",\n        \"false_negative\": \"An attacker compromises a CI/CD service account (e.g., from Terraform Cloud) and uses it to provision malicious instances, which would be filtered by this rule.\",\n        \"false_positive\": \"A developer logs into the GCP console and creates a new VM in their sandbox project to test a new application.\",\n        \"true_negative\": \"A Terraform pipeline, running with a service account, creates a new set of web server instances as part of a blue/green deployment.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit#audit_log_entry_structure\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"v1.compute.instances.insert\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"compromised-user@example.com\",\n          \"protoPayload.request.machineType\": \"n1-standard-1\"\n        }\n      }\n    }\n  ],\n  \"total_rules\": 13,\n  \"ttp_coverage\": [\n    \"T1550.001\",\n    \"T1098\",\n    \"T1490\",\n    \"T1578.003\",\n    \"T1098.004\",\n    \"T1562.007\",\n    \"T1136.003\",\n    \"T1537\",\n    \"T1078.004\",\n    \"T1087.004\",\n    \"T1496\"\n  ],\n  \"generation_notes\": \"Refined rule set to improve accuracy and coverage. Key changes include: broadening impersonation detection to include the 'iamcredentials' API, adding 'startup-script-url' and IPv6 coverage, improving SSH key detection, and making the BigQuery exfiltration rule more robust.\"\n}\"\"\"\n    ),\n  ],\n  role='model'\n), grounding_metadata=None, partial=None, turn_complete=None, finish_reason=<FinishReason.STOP: 'STOP'>, error_code=None, error_message=None, interrupted=None, custom_metadata=None, usage_metadata=GenerateContentResponseUsageMetadata(\n  candidates_token_count=10782,\n  candidates_tokens_details=[\n    ModalityTokenCount(\n      modality=<MediaModality.TEXT: 'TEXT'>,\n      token_count=10782\n    ),\n  ],\n  prompt_token_count=52410,\n  prompt_tokens_details=[\n    ModalityTokenCount(\n      modality=<MediaModality.TEXT: 'TEXT'>,\n      token_count=52410\n    ),\n  ],\n  thoughts_token_count=4983,\n  total_token_count=68175,\n  traffic_type=<TrafficType.ON_DEMAND: 'ON_DEMAND'>\n), live_session_resumption_update=None, input_transcription=None, output_transcription=None, avg_logprobs=-0.15514440435665344, logprobs_result=None, cache_metadata=None, citation_metadata=None, interaction_id=None, invocation_id='e-8f3b0b44-9b96-4ea3-91e4-f624637ca23e', author='sigma_generator', actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}, requested_tool_confirmations={}, compaction=None, end_of_agent=None, agent_state=None, rewind_before_invocation_id=None), long_running_tool_ids=None, branch=None, id='d70a9493-9bc9-43ce-9b54-61e24ed73ac8', timestamp=1770497863.990848)]",
  "formatted_rules": "[Event(model_version='gemini-2.5-flash', content=Content(\n  parts=[\n    Part(\n      text=\"\"\"{\n  \"rules\": [\n    {\n      \"title\": \"GCP Service Account Impersonation by Non-SA Principal\",\n      \"id\": \"c6a218d8-7b9e-4c3e-8f1b-9a7c6d5e4f3a\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects when a non-service account principal, such as a user account, generates an access token for a service account. This is a primary method for privilege escalation (T1550.001) where an attacker with ''iam.serviceAccountTokenCreator'' permissions can impersonate a higher-privilege service account to inherit its permissions, often bypassing user-based controls like MFA.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1550/001/\",\n        \"https://cloud.google.com/iam/docs/impersonating-service-accounts\",\n        \"https://cloud.google.com/iam/docs/reference/credentials/rest/v1/projects.serviceAccounts/generateAccessToken\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-31\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.privilege_escalation\",\n        \"attack.credential_access\",\n        \"attack.t1550.001\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.serviceName\": [\n            \"iam.googleapis.com\",\n            \"iamcredentials.googleapis.com\"\n          ],\n          \"protoPayload.methodName\": [\n            \"GenerateAccessToken\",\n            \"google.iam.credentials.v1.IAMCredentials.GenerateAccessToken\"\n          ],\n          \"resource.type\": \"service_account\",\n          \"protoPayload.status.code\": 0\n        },\n        \"filter_legitimate\": {\n          \"protoPayload.authenticationInfo.principalEmail|endswith\": \".gserviceaccount.com\"\n        },\n        \"condition\": \"selection and not filter_legitimate\"\n      },\n      \"falsepositives\": [\n        \"Legitimate break-glass procedures where an administrator manually impersonates a service account for emergency access.\",\n        \"CI/CD pipelines or infrastructure-as-code tools that are configured to use user credentials instead of a dedicated service account (a non-recommended practice).\"\n      ],\n      \"level\": \"high\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"protoPayload.request.name\",\n        \"resource.labels.project_id\",\n        \"timestamp\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"An attacker with a compromised user account 'attacker@example.com' runs `gcloud iam service-accounts generate-access-token admin-sa@project.iam.gserviceaccount.com` to escalate privileges.\",\n        \"false_negative\": \"An attacker uses a compromised service account to impersonate another service account. This rule would not trigger as the filter condition would match.\",\n        \"false_positive\": \"A site reliability engineer 'sre@example.com' follows a documented break-glass runbook to impersonate a service account to fix a production issue.\",\n        \"true_negative\": \"A GKE node's service account authenticates to another GCP service, which involves token generation between service accounts.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit#audit_log_entry_structure\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"google.iam.credentials.v1.IAMCredentials.GenerateAccessToken\",\n          \"protoPayload.serviceName\": \"iamcredentials.googleapis.com\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"attacker@evil.com\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP IAM Policy Changed to Grant Highly Privileged Role\",\n      \"id\": \"d1e2f3a4-b5c6-4d7e-8f9b-0c1d2e3f4a5b\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects when a GCP IAM policy is modified to grant a highly permissive role (e.g., Owner, Editor, Service Account Token Creator) to a principal. This action provides broad access and is a critical privilege escalation technique (T1098).\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1098/\",\n        \"https://cloud.google.com/iam/docs/understanding-roles\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-31\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.privilege_escalation\",\n        \"attack.t1098\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.serviceName\": \"cloudresourcemanager.googleapis.com\",\n          \"protoPayload.methodName\": \"SetIamPolicy\",\n          \"protoPayload.request.policy.bindings.role\": [\n            \"roles/owner\",\n            \"roles/editor\",\n            \"roles/iam.serviceAccountTokenCreator\"\n          ],\n          \"protoPayload.status.code\": 0\n        },\n        \"filter_legitimate\": {\n          \"protoPayload.authenticationInfo.principalEmail\": [\n            \"org-admin@company.com\",\n            \"terraform-prod@project.iam.gserviceaccount.com\"\n          ]\n        },\n        \"condition\": \"selection and not filter_legitimate\"\n      },\n      \"falsepositives\": [\n        \"Initial project setup by authorized organization administrators or infrastructure-as-code (IaC) service accounts.\",\n        \"Approved break-glass procedures for emergency project access.\"\n      ],\n      \"level\": \"critical\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"protoPayload.request.policy.bindings.members\",\n        \"protoPayload.request.policy.bindings.role\",\n        \"resource.labels.project_id\",\n        \"timestamp\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"A compromised developer account with 'resourcemanager.projects.setIamPolicy' permission adds an external attacker account with the 'roles/owner' role on the project.\",\n        \"false_negative\": \"An attacker grants a custom role with permissions equivalent to 'owner' (e.g., '*') instead of one of the specified predefined roles.\",\n        \"false_positive\": \"An authorized Terraform service account assigns a project owner during the automated creation of a new GCP project.\",\n        \"true_negative\": \"An administrator grants a user the 'roles/viewer' role on a project.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit#audit_log_entry_structure\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"SetIamPolicy\",\n          \"protoPayload.request.policy.bindings.role\": \"roles/owner\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"compromised-user@example.com\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP Compute Engine Snapshot Deleted\",\n      \"id\": \"e3f4a5b6-c7d8-4b9c-8d1e-2f3a4b5c6d7e\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects the deletion of a Compute Engine disk snapshot. Attackers may delete snapshots to inhibit system recovery (T1490) as part of a ransomware or destructive attack. This activity is often noisy; it is best to correlate with other suspicious events or tune for high-volume deletions from a single principal.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1490/\",\n        \"https://cloud.google.com/compute/docs/disks/create-snapshots\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-31\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.impact\",\n        \"attack.t1490\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.serviceName\": \"compute.googleapis.com\",\n          \"protoPayload.methodName\": \"v1.compute.snapshots.delete\",\n          \"protoPayload.status.code\": 0\n        },\n        \"filter_legitimate\": {\n          \"protoPayload.authenticationInfo.principalEmail|endswith\": [\n            \"@gcp-sa-cloud-storage-transfer.iam.gserviceaccount.com\",\n            \"-compute@developer.gserviceaccount.com\"\n          ]\n        },\n        \"condition\": \"selection and not filter_legitimate\"\n      },\n      \"falsepositives\": [\n        \"Automated backup lifecycle management scripts or tools deleting old or expired snapshots.\",\n        \"Manual cleanup of test or development snapshots by engineers.\"\n      ],\n      \"level\": \"high\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"resource.labels.project_id\",\n        \"protoPayload.resourceName\",\n        \"timestamp\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"A compromised account executes a script to loop through and delete all available disk snapshots in a project.\",\n        \"false_negative\": \"An attacker removes the IAM policy that grants access to the snapshots, effectively making them inaccessible without deleting them.\",\n        \"false_positive\": \"A daily scheduled job running as a service account deletes snapshots older than 30 days as per the defined retention policy.\",\n        \"true_negative\": \"A new snapshot is created as part of a daily backup process.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit#audit_log_entry_structure\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"v1.compute.snapshots.delete\",\n          \"protoPayload.serviceName\": \"compute.googleapis.com\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"attacker@evil.com\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP Compute Instance Startup Script Modified\",\n      \"id\": \"f5a6b7c8-d9e0-4c1d-8e2f-3a4b5c6d7e8f\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects modification of the 'startup-script' or 'startup-script-url' metadata on a Compute Engine instance. Attackers use this (T1578.003) to establish persistence, as the script runs with root privileges each time the instance boots, allowing them to execute malicious code.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1578/003/\",\n        \"https://cloud.google.com/compute/docs/instances/startup-scripts/setting-startup-script\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-31\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.persistence\",\n        \"attack.t1578.003\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.serviceName\": \"compute.googleapis.com\",\n          \"protoPayload.methodName\": \"v1.compute.instances.setMetadata\",\n          \"protoPayload.request.metadata.items.key\": [\n            \"startup-script\",\n            \"startup-script-url\"\n          ],\n          \"protoPayload.status.code\": 0\n        },\n        \"filter_legitimate\": {\n          \"protoPayload.authenticationInfo.principalEmail|endswith\": [\n            \"@cloudservices.gserviceaccount.com\",\n            \"terraform@my-project.iam.gserviceaccount.com\"\n          ]\n        },\n        \"condition\": \"selection and not filter_legitimate\"\n      },\n      \"falsepositives\": [\n        \"Legitimate updates to instance startup scripts by administrators or configuration management tools (e.g., Ansible, Terraform) to install or update software.\",\n        \"Google Cloud Platform services updating metadata on managed instance groups.\"\n      ],\n      \"level\": \"high\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"protoPayload.resourceName\",\n        \"resource.labels.project_id\",\n        \"timestamp\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"An attacker modifies the 'startup-script-url' of a web server to point to a malicious script hosted in a public bucket.\",\n        \"false_negative\": \"An attacker modifies the 'shutdown-script' metadata instead, which executes on instance shutdown.\",\n        \"false_positive\": \"A system administrator updates the startup script via the console to install a new security agent on a VM.\",\n        \"true_negative\": \"A user modifies a different metadata key, such as 'serial-port-enable', on an instance.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit#audit_log_entry_structure\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"v1.compute.instances.setMetadata\",\n          \"protoPayload.request.metadata.items.key\": \"startup-script-url\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"compromised-user@example.com\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP SSH Key Added to Instance or Project Metadata\",\n      \"id\": \"a7b8c9d0-e1f2-4d3e-8f4a-5b6c7d8e9f0a\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects when SSH keys are added to the metadata of a Compute Engine instance or an entire project. Attackers use this (T1098.004) to create a persistent SSH backdoor, bypassing firewalls and other access controls.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1098/004/\",\n        \"https://cloud.google.com/compute/docs/instances/managing-instance-access\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-31\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.persistence\",\n        \"attack.t1098.004\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.serviceName\": \"compute.googleapis.com\",\n          \"protoPayload.methodName\": [\n            \"v1.compute.instances.setMetadata\",\n            \"v1.compute.projects.setCommonInstanceMetadata\",\n            \"beta.compute.projects.setCommonInstanceMetadata\"\n          ],\n          \"protoPayload.request.metadata.items.key\": [\n            \"ssh-keys\",\n            \"sshKeys\"\n          ],\n          \"protoPayload.status.code\": 0\n        },\n        \"filter_legitimate\": {\n          \"protoPayload.authenticationInfo.principalEmail\": \"google-oslogin@google.com\"\n        },\n        \"condition\": \"selection and not filter_legitimate\"\n      },\n      \"falsepositives\": [\n        \"Administrators legitimately adding SSH keys for new developers or for their own access.\",\n        \"Automated onboarding scripts that add user SSH keys to projects.\",\n        \"The OS Login service managing SSH keys, which may use a dedicated service account.\"\n      ],\n      \"level\": \"high\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"protoPayload.resourceName\",\n        \"protoPayload.methodName\",\n        \"resource.labels.project_id\",\n        \"timestamp\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"An attacker uses a compromised account to call 'compute.projects.setCommonInstanceMetadata' and inject their public SSH key into the 'ssh-keys' value for all VMs in the project.\",\n        \"false_negative\": \"An attacker gains OS-level access and adds their key directly to the '~/.ssh/authorized_keys' file on the instance, bypassing the GCP metadata API.\",\n        \"false_positive\": \"An engineering manager adds a new team member's public SSH key to a project's metadata to grant them access.\",\n        \"true_negative\": \"A user modifies the 'startup-script' metadata key.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit#audit_log_entry_structure\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"v1.compute.projects.setCommonInstanceMetadata\",\n          \"protoPayload.request.metadata.items.key\": \"ssh-keys\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"attacker@evil.com\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP Firewall Rule Allowing Unrestricted Ingress Created\",\n      \"id\": \"b9c0d1e2-f3a4-4e5f-8a6b-7c8d9e0f1a2b\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects the creation or modification of a GCP Firewall Rule that allows inbound traffic from any source (IPv4 '0.0.0.0/0' or IPv6 '::/0'). Attackers use this (T1562.007) to open ports for C2 communication or to expose internal services.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1562/007/\",\n        \"https://cloud.google.com/vpc/docs/firewalls\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-31\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.defense_evasion\",\n        \"attack.t1562.007\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.serviceName\": \"compute.googleapis.com\",\n          \"protoPayload.methodName|startswith\": \"v1.compute.firewalls.\",\n          \"protoPayload.request.sourceRanges\": [\n            \"0.0.0.0/0\",\n            \"::/0\"\n          ],\n          \"protoPayload.status.code\": 0\n        },\n        \"filter_legitimate\": {\n          \"protoPayload.request.allowed.IPProtocol\": \"tcp\",\n          \"protoPayload.request.allowed.ports\": [\n            \"80\",\n            \"443\"\n          ]\n        },\n        \"condition\": \"selection and not filter_legitimate\"\n      },\n      \"falsepositives\": [\n        \"Legitimate creation of firewall rules to expose public web servers (HTTP/HTTPS) to the internet.\"\n      ],\n      \"level\": \"high\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"protoPayload.resourceName\",\n        \"protoPayload.request.allowed.IPProtocol\",\n        \"protoPayload.request.allowed.ports\",\n        \"resource.labels.project_id\",\n        \"timestamp\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"An attacker creates a new firewall rule named 'allow-rdp' that permits TCP traffic on port 3389 from '0.0.0.0/0'.\",\n        \"false_negative\": \"An attacker creates a rule allowing traffic from a very wide, but not universal, CIDR range like '0.0.0.0/1'.\",\n        \"false_positive\": \"A network administrator creates a firewall rule to allow HTTPS (port 443) traffic from '0.0.0.0/0' to a new set of web servers.\",\n        \"true_negative\": \"An administrator creates a firewall rule to allow traffic between two internal subnets.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit#audit_log_entry_structure\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"v1.compute.firewalls.insert\",\n          \"protoPayload.request.sourceRanges\": \"0.0.0.0/0\",\n          \"protoPayload.request.allowed.ports\": \"3389\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP Service Account Created\",\n      \"id\": \"c1d2e3f4-a5b6-4f7a-8b9c-0d1e2f3a4b5c\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects the creation of a new service account (T1136.003). Attackers create new service accounts to use as a persistent backdoor, as they are non-human identities that are often less scrutinized than user accounts.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1136/003/\",\n        \"https://cloud.google.com/iam/docs/creating-managing-service-accounts\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-31\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.persistence\",\n        \"attack.t1136.003\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.serviceName\": \"iam.googleapis.com\",\n          \"protoPayload.methodName\": \"google.iam.admin.v1.CreateServiceAccount\",\n          \"protoPayload.status.code\": 0\n        },\n        \"filter_legitimate\": {\n          \"protoPayload.authenticationInfo.principalEmail|endswith\": [\n            \"-compute@developer.gserviceaccount.com\",\n            \"terraform-prod@my-project.iam.gserviceaccount.com\"\n          ]\n        },\n        \"condition\": \"selection and not filter_legitimate\"\n      },\n      \"falsepositives\": [\n        \"Legitimate creation of service accounts for new applications or resources by administrators.\",\n        \"Automated infrastructure-as-code (IaC) tools like Terraform provisioning new service accounts as part of a deployment.\"\n      ],\n      \"level\": \"low\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"protoPayload.request.accountId\",\n        \"protoPayload.response.email\",\n        \"resource.labels.project_id\",\n        \"timestamp\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"An attacker, having compromised a developer account, creates a new service account named 'gcp-billing-sync' to blend in and use as a backdoor.\",\n        \"false_negative\": \"An attacker compromises and re-uses an existing, dormant service account instead of creating a new one.\",\n        \"false_positive\": \"Terraform runs and creates a new service account for a new application as defined in its configuration files.\",\n        \"true_negative\": \"An administrator lists the existing service accounts in a project.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit#audit_log_entry_structure\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"google.iam.admin.v1.CreateServiceAccount\",\n          \"protoPayload.request.accountId\": \"backdoor-sa\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"compromised-user@example.com\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP BigQuery Data Extraction Job Initiated\",\n      \"id\": \"d3e4f5a6-b7c8-4a9b-8c1d-2e3f4a5b6c7d\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects a BigQuery extract job being initiated. Attackers use this (T1537) to exfiltrate large amounts of data by exporting tables to a Cloud Storage bucket. All exports should be investigated to ensure the destination bucket is an authorized location.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1537/\",\n        \"https://cloud.google.com/bigquery/docs/exporting-data\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-31\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.exfiltration\",\n        \"attack.t1537\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.serviceName\": \"bigquery.googleapis.com\",\n          \"protoPayload.methodName\": \"jobservice.insert\",\n          \"protoPayload.request.job.jobConfiguration.extract.destinationUris|contains\": \"gs://\",\n          \"protoPayload.status.code\": 0\n        },\n        \"filter_legitimate\": {\n          \"protoPayload.request.job.jobConfiguration.extract.destinationUris|startswith\": \"gs://internal-backup-bucket-\"\n        },\n        \"condition\": \"selection and not filter_legitimate\"\n      },\n      \"falsepositives\": [\n        \"Scheduled jobs that export data to legitimate, known internal or partner Cloud Storage buckets.\",\n        \"Data analysts creating backups or exporting sanitized data for local analysis.\",\n        \"This rule should be tuned by adding all legitimate destination bucket prefixes to the filter condition.\"\n      ],\n      \"level\": \"medium\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"protoPayload.request.job.jobConfiguration.extract.sourceTable.tableId\",\n        \"protoPayload.request.job.jobConfiguration.extract.destinationUris\",\n        \"resource.labels.project_id\",\n        \"timestamp\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"An attacker initiates a BigQuery extract job to copy the 'users' table to an external bucket 'gs://attacker-owned-bucket/data.csv'.\",\n        \"false_negative\": \"An attacker exfiltrates data by repeatedly using the 'tabledata.list' API, which avoids a single large export job.\",\n        \"false_positive\": \"An automated ETL process exports daily transaction data to a Cloud Storage bucket named 'gs://internal-backup-bucket-daily/'.\",\n        \"true_negative\": \"A data scientist runs a complex `SELECT` query in the BigQuery UI, which also creates a 'jobservice.insert' event but without an 'extract' configuration.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit#audit_log_entry_structure\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"jobservice.insert\",\n          \"protoPayload.serviceName\": \"bigquery.googleapis.com\",\n          \"protoPayload.request.job.jobConfiguration.extract.destinationUris\": \"gs://attacker-public-bucket/export.json\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP Windows Instance Password Created or Reset\",\n      \"id\": \"e5f6a7b8-c9d0-4b1c-8d2e-3f4a5b6c7d8e\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects the creation or reset of a Windows user password on a Compute Engine instance via the GCP metadata API. This technique (T1098) allows an attacker with cloud permissions to gain OS-level access.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1098/\",\n        \"https://cloud.google.com/compute/docs/instances/reset-windows-password\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-31\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.privilege_escalation\",\n        \"attack.t1098\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.serviceName\": \"compute.googleapis.com\",\n          \"protoPayload.methodName\": \"v1.compute.instances.setMetadata\",\n          \"protoPayload.request.metadata.items.key\": \"windows-keys\",\n          \"protoPayload.status.code\": 0\n        },\n        \"filter_legitimate\": null,\n        \"condition\": \"selection\"\n      },\n      \"falsepositives\": [\n        \"A system administrator legitimately using the 'reset-windows-password' gcloud command or console feature to regain access to a VM.\",\n        \"Automated account recovery processes that leverage this mechanism.\"\n      ],\n      \"level\": \"high\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"protoPayload.resourceName\",\n        \"resource.labels.project_id\",\n        \"timestamp\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"An attacker with Compute Admin rights uses `gcloud compute reset-windows-password` to create a new user and password for a domain controller VM.\",\n        \"false_negative\": \"An attacker uses a startup script to reset a local user password on a Linux VM, which would not involve the 'windows-keys' metadata key.\",\n        \"false_positive\": \"A help desk technician follows a standard procedure to reset a user's password on their Windows workstation VM.\",\n        \"true_negative\": \"An administrator reboots a Windows VM using the `v1.compute.instances.stop` and `v1.compute.instances.start` API calls.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit#audit_log_entry_structure\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"v1.compute.instances.setMetadata\",\n          \"protoPayload.request.metadata.items.key\": \"windows-keys\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"attacker-sa@project.iam.gserviceaccount.com\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP IAM Policy Modified at Org or Folder Level\",\n      \"id\": \"f7a8b9c0-d1e2-4c3d-8e4f-5a6b7c8d9e0f\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects modifications to IAM policies at the Organization or Folder level. Changes at this level are high-impact and can be used for widespread lateral movement (T1078.004) by granting an attacker's account permissions across multiple projects.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1078/004/\",\n        \"https://cloud.google.com/resource-manager/docs/access-control-org\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-31\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.lateral_movement\",\n        \"attack.privilege_escalation\",\n        \"attack.t1078.004\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.serviceName\": \"cloudresourcemanager.googleapis.com\",\n          \"protoPayload.methodName\": \"SetIamPolicy\",\n          \"resource.type\": [\n            \"organization\",\n            \"folder\"\n          ],\n          \"protoPayload.status.code\": 0\n        },\n        \"filter_legitimate\": {\n          \"protoPayload.authenticationInfo.principalEmail\": [\n            \"org-admin-group@example.com\",\n            \"central-iac@my-org.iam.gserviceaccount.com\"\n          ]\n        },\n        \"condition\": \"selection and not filter_legitimate\"\n      },\n      \"falsepositives\": [\n        \"Authorized Organization Administrators or central IaC service accounts deploying new organization-wide security policies or role bindings.\"\n      ],\n      \"level\": \"critical\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"protoPayload.request.policy.bindings.role\",\n        \"protoPayload.request.policy.bindings.members\",\n        \"resource.type\",\n        \"resource.labels.folder_id\",\n        \"resource.labels.organization_id\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"An attacker who compromised a Folder Admin account adds their external account as 'Folder Owner', gaining control over all projects within that folder.\",\n        \"false_negative\": \"An attacker moves laterally between two projects without modifying Folder or Organization level policies.\",\n        \"false_positive\": \"A central security team, using an approved service account, applies a new custom role binding to all projects by setting the IAM policy at the organization level.\",\n        \"true_negative\": \"A project administrator grants a developer 'roles/viewer' on a single project.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit#audit_log_entry_structure\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"SetIamPolicy\",\n          \"resource.type\": \"folder\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"compromised-folder-admin@example.com\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP Project-Level IAM Policy Discovery\",\n      \"id\": \"a9b0c1d2-e3f4-4d5e-8f6a-7b8c9d0e1f2a\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects the use of 'GetIamPolicy' at a project level. This is a foundational discovery technique (T1087.004) used by attackers to map the permission landscape, identify principals and roles, and find potential privilege escalation paths.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1087/004/\",\n        \"https://cloud.google.com/iam/docs/reference/rest/v1/projects/getIamPolicy\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-31\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.discovery\",\n        \"attack.t1087.004\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.serviceName\": \"cloudresourcemanager.googleapis.com\",\n          \"protoPayload.methodName\": \"GetIamPolicy\"\n        },\n        \"filter_legitimate\": {\n          \"protoPayload.authenticationInfo.principalEmail|endswith\": [\n            \"@cloudservices.gserviceaccount.com\",\n            \"-compute@developer.gserviceaccount.com\",\n            \"@gcp-sa-config-connector.iam.gserviceaccount.com\"\n          ]\n        },\n        \"condition\": \"selection and not filter_legitimate\"\n      },\n      \"falsepositives\": [\n        \"Security scanners, compliance tools, or audit scripts enumerating permissions across projects.\",\n        \"Administrators or developers checking permissions while troubleshooting.\",\n        \"GCP-internal services performing checks.\"\n      ],\n      \"level\": \"informational\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"resource.labels.project_id\",\n        \"timestamp\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"An attacker runs `gcloud projects get-iam-policy <project-id>` after gaining initial access to understand who has what permissions.\",\n        \"false_negative\": \"An attacker uses the `gcloud asset search-all-iam-policies` command, which uses a different API and might not be caught by this rule.\",\n        \"false_positive\": \"A security engineer runs a script that iterates through all projects and calls `get-iam-policy` on each one to generate a permissions report.\",\n        \"true_negative\": \"A user gets the IAM policy for a single Cloud Storage bucket, which uses a different serviceName.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit#audit_log_entry_structure\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"GetIamPolicy\",\n          \"protoPayload.serviceName\": \"cloudresourcemanager.googleapis.com\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"attacker@evil.com\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP Service Account Discovery\",\n      \"id\": \"b1c2d3e4-f5a6-4e7f-8b9c-0d1e2f3a4b5c\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects the listing of service accounts in a project. This is a common discovery technique (T1087.004) used by attackers after initial access to identify high-privilege service accounts for impersonation or targeting.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1087/004/\",\n        \"https://cloud.google.com/iam/docs/reference/rest/v1/projects.serviceAccounts/list\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-31\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.discovery\",\n        \"attack.t1087.004\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.serviceName\": \"iam.googleapis.com\",\n          \"protoPayload.methodName\": \"google.iam.admin.v1.ListServiceAccounts\"\n        },\n        \"filter_legitimate\": {\n          \"protoPayload.authenticationInfo.principalEmail|endswith\": [\n            \"@cloudservices.gserviceaccount.com\",\n            \"-compute@developer.gserviceaccount.com\"\n          ]\n        },\n        \"condition\": \"selection and not filter_legitimate\"\n      },\n      \"falsepositives\": [\n        \"Security scanners or compliance scripts enumerating service accounts.\",\n        \"Administrators using the GCP console or gcloud CLI to view service accounts.\"\n      ],\n      \"level\": \"informational\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"resource.labels.project_id\",\n        \"timestamp\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"An attacker runs `gcloud iam service-accounts list` to find potential target accounts for impersonation.\",\n        \"false_negative\": \"An attacker obtains a list of service accounts through an out-of-band method, such as from public code repositories.\",\n        \"false_positive\": \"A developer lists the service accounts in their project to find the correct one for an application.\",\n        \"true_negative\": \"An administrator creates a new service account.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit#audit_log_entry_structure\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"google.iam.admin.v1.ListServiceAccounts\",\n          \"protoPayload.serviceName\": \"iam.googleapis.com\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"attacker@evil.com\"\n        }\n      }\n    },\n    {\n      \"title\": \"GCP Compute Instance Created By Non-Service Account\",\n      \"id\": \"c3d4e5f6-a7b8-4f9a-8b1c-2d3e4f5a6b7c\",\n      \"status\": \"experimental\",\n      \"description\": \"Detects the creation of a Compute Engine instance by a principal that is not a service account. In automated environments, infrastructure is typically provisioned by IaC tools using service accounts. Manual creation by a user can indicate resource hijacking (T1496) for purposes like cryptomining.\",\n      \"references\": [\n        \"https://attack.mitre.org/techniques/T1496/\",\n        \"https://cloud.google.com/compute/docs/reference/rest/v1/instances/insert\"\n      ],\n      \"author\": \"Automated Detection Agent\",\n      \"date\": \"2024-07-31\",\n      \"modified\": \"2024-07-31\",\n      \"tags\": [\n        \"attack.impact\",\n        \"attack.t1496\"\n      ],\n      \"logsource\": {\n        \"product\": \"gcp\",\n        \"service\": \"gcp.audit\"\n      },\n      \"detection\": {\n        \"selection\": {\n          \"protoPayload.serviceName\": \"compute.googleapis.com\",\n          \"protoPayload.methodName\": \"v1.compute.instances.insert\",\n          \"protoPayload.status.code\": 0\n        },\n        \"filter_legitimate\": {\n          \"protoPayload.authenticationInfo.principalEmail|endswith\": \".gserviceaccount.com\"\n        },\n        \"condition\": \"selection and not filter_legitimate\"\n      },\n      \"falsepositives\": [\n        \"Engineers or developers manually creating VMs for testing or debugging in development projects.\",\n        \"Administrators creating a one-off instance for a specific purpose.\"\n      ],\n      \"level\": \"medium\",\n      \"fields\": [\n        \"protoPayload.authenticationInfo.principalEmail\",\n        \"protoPayload.resourceName\",\n        \"resource.labels.project_id\",\n        \"protoPayload.request.machineType\",\n        \"protoPayload.request.disks.initializeParams.sourceImage\",\n        \"timestamp\"\n      ],\n      \"test_scenarios\": {\n        \"true_positive\": \"An attacker with compromised user credentials manually creates 100 small compute instances to use for a botnet or cryptomining.\",\n        \"false_negative\": \"An attacker compromises a CI/CD service account (e.g., from Terraform Cloud) and uses it to provision malicious instances, which would be filtered by this rule.\",\n        \"false_positive\": \"A developer logs into the GCP console and creates a new VM in their sandbox project to test a new application.\",\n        \"true_negative\": \"A Terraform pipeline, running with a service account, creates a new set of web server instances as part of a blue/green deployment.\",\n        \"log_source_schema\": \"https://cloud.google.com/logging/docs/audit#audit_log_entry_structure\",\n        \"example_log_fields\": {\n          \"protoPayload.methodName\": \"v1.compute.instances.insert\",\n          \"protoPayload.authenticationInfo.principalEmail\": \"compromised-user@example.com\",\n          \"protoPayload.request.machineType\": \"n1-standard-1\"\n        }\n      }\n    }\n  ],\n  \"total_rules\": 13,\n  \"ttp_coverage\": [\n    \"T1550.001\",\n    \"T1098\",\n    \"T1490\",\n    \"T1578.003\",\n    \"T1098.004\",\n    \"T1562.007\",\n    \"T1136.003\",\n    \"T1537\",\n    \"T1078.004\",\n    \"T1087.004\",\n    \"T1496\"\n  ],\n  \"generation_notes\": \"Refined rule set to improve accuracy and coverage. Key changes include: broadening impersonation detection to include the 'iamcredentials' API, adding 'startup-script-url' and IPv6 coverage, improving SSH key detection, and making the BigQuery exfiltration rule more robust.\"\n}\"\"\"\n    ),\n  ],\n  role='model'\n), grounding_metadata=None, partial=None, turn_complete=None, finish_reason=<FinishReason.STOP: 'STOP'>, error_code=None, error_message=None, interrupted=None, custom_metadata=None, usage_metadata=GenerateContentResponseUsageMetadata(\n  candidates_token_count=10782,\n  candidates_tokens_details=[\n    ModalityTokenCount(\n      modality=<MediaModality.TEXT: 'TEXT'>,\n      token_count=10782\n    ),\n  ],\n  prompt_token_count=13972,\n  prompt_tokens_details=[\n    ModalityTokenCount(\n      modality=<MediaModality.TEXT: 'TEXT'>,\n      token_count=13972\n    ),\n  ],\n  thoughts_token_count=28098,\n  total_token_count=52852,\n  traffic_type=<TrafficType.ON_DEMAND: 'ON_DEMAND'>\n), live_session_resumption_update=None, input_transcription=None, output_transcription=None, avg_logprobs=-0.557312860844463, logprobs_result=None, cache_metadata=None, citation_metadata=None, interaction_id=None, invocation_id='e-5ba201fb-bff2-49d1-b5b1-cf62014a7439', author='sigma_formatter', actions=EventActions(skip_summarization=None, state_delta={}, artifact_delta={}, transfer_to_agent=None, escalate=None, requested_auth_configs={}, requested_tool_confirmations={}, compaction=None, end_of_agent=None, agent_state=None, rewind_before_invocation_id=None), long_running_tool_ids=None, branch=None, id='75d471a6-87b0-4fcb-bc03-50b6a22b6936', timestamp=1770497969.042591)]"
}