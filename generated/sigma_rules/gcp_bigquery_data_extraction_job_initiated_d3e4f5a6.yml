title: GCP BigQuery Data Extraction Job Initiated
id: d3e4f5a6-b7c8-4a9b-8c1d-2e3f4a5b6c7d
status: experimental
description: Detects a BigQuery extract job being initiated. Attackers use this (T1537)
  to exfiltrate large amounts of data by exporting tables to a Cloud Storage bucket.
  All exports should be investigated to ensure the destination bucket is an authorized
  location.
references:
- https://attack.mitre.org/techniques/T1537/
- https://cloud.google.com/bigquery/docs/exporting-data
author: Automated Detection Agent
date: '2024-07-31'
modified: '2024-07-31'
tags:
- attack.exfiltration
- attack.t1537
logsource:
  product: gcp
  service: gcp.audit
detection:
  selection:
    protoPayload.serviceName: bigquery.googleapis.com
    protoPayload.methodName: jobservice.insert
    protoPayload.request.job.jobConfiguration.extract.destinationUris|contains: gs://
    protoPayload.status.code: 0
  filter_legitimate:
    protoPayload.request.job.jobConfiguration.extract.destinationUris|startswith: gs://internal-backup-bucket-
  condition: selection and not filter_legitimate
falsepositives:
- Scheduled jobs that export data to legitimate, known internal or partner Cloud Storage
  buckets.
- Data analysts creating backups or exporting sanitized data for local analysis.
- This rule should be tuned by adding all legitimate destination bucket prefixes to
  the filter condition.
level: medium
fields:
- protoPayload.authenticationInfo.principalEmail
- protoPayload.request.job.jobConfiguration.extract.sourceTable.tableId
- protoPayload.request.job.jobConfiguration.extract.destinationUris
- resource.labels.project_id
- timestamp
test_scenarios:
  true_positive: An attacker initiates a BigQuery extract job to copy the 'users'
    table to an external bucket 'gs://attacker-owned-bucket/data.csv'.
  false_negative: An attacker exfiltrates data by repeatedly using the 'tabledata.list'
    API, which avoids a single large export job.
  false_positive: An automated ETL process exports daily transaction data to a Cloud
    Storage bucket named 'gs://internal-backup-bucket-daily/'.
  true_negative: A data scientist runs a complex `SELECT` query in the BigQuery UI,
    which also creates a 'jobservice.insert' event but without an 'extract' configuration.
  log_source_schema: https://cloud.google.com/logging/docs/audit#audit_log_entry_structure
  example_log_fields:
    protoPayload.methodName: jobservice.insert
    protoPayload.serviceName: bigquery.googleapis.com
    protoPayload.request.job.jobConfiguration.extract.destinationUris: gs://attacker-public-bucket/export.json
