title: GCP Compute Instance Startup Script Modified
id: f5a6b7c8-d9e0-4c1d-8e2f-3a4b5c6d7e8f
status: experimental
description: Detects modification of the 'startup-script' or 'startup-script-url'
  metadata on a Compute Engine instance. Attackers use this (T1578.003) to establish
  persistence, as the script runs with root privileges each time the instance boots,
  allowing them to execute malicious code.
references:
- https://attack.mitre.org/techniques/T1578/003/
- https://cloud.google.com/compute/docs/instances/startup-scripts/setting-startup-script
author: Automated Detection Agent
date: '2024-07-31'
modified: '2024-07-31'
tags:
- attack.persistence
- attack.t1578.003
logsource:
  product: gcp
  service: gcp.audit
detection:
  selection:
    protoPayload.serviceName: compute.googleapis.com
    protoPayload.methodName: v1.compute.instances.setMetadata
    protoPayload.request.metadata.items.key:
    - startup-script
    - startup-script-url
    protoPayload.status.code: 0
  filter_legitimate:
    protoPayload.authenticationInfo.principalEmail|endswith:
    - '@cloudservices.gserviceaccount.com'
    - terraform@my-project.iam.gserviceaccount.com
  condition: selection and not filter_legitimate
falsepositives:
- Legitimate updates to instance startup scripts by administrators or configuration
  management tools (e.g., Ansible, Terraform) to install or update software.
- Google Cloud Platform services updating metadata on managed instance groups.
level: high
fields:
- protoPayload.authenticationInfo.principalEmail
- protoPayload.resourceName
- resource.labels.project_id
- timestamp
test_scenarios:
  true_positive: An attacker modifies the 'startup-script-url' of a web server to
    point to a malicious script hosted in a public bucket.
  false_negative: An attacker modifies the 'shutdown-script' metadata instead, which
    executes on instance shutdown.
  false_positive: A system administrator updates the startup script via the console
    to install a new security agent on a VM.
  true_negative: A user modifies a different metadata key, such as 'serial-port-enable',
    on an instance.
  log_source_schema: https://cloud.google.com/logging/docs/audit#audit_log_entry_structure
  example_log_fields:
    protoPayload.methodName: v1.compute.instances.setMetadata
    protoPayload.request.metadata.items.key: startup-script-url
    protoPayload.authenticationInfo.principalEmail: compromised-user@example.com
