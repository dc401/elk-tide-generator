title: GCP Service Account Impersonation by Non-SA Principal
id: c6a218d8-7b9e-4c3e-8f1b-9a7c6d5e4f3a
status: experimental
description: Detects when a non-service account principal, such as a user account,
  generates an access token for a service account. This is a primary method for privilege
  escalation (T1550.001) where an attacker with ''iam.serviceAccountTokenCreator''
  permissions can impersonate a higher-privilege service account to inherit its permissions,
  often bypassing user-based controls like MFA.
references:
- https://attack.mitre.org/techniques/T1550/001/
- https://cloud.google.com/iam/docs/impersonating-service-accounts
- https://cloud.google.com/iam/docs/reference/credentials/rest/v1/projects.serviceAccounts/generateAccessToken
author: Automated Detection Agent
date: '2024-07-31'
modified: '2024-07-31'
tags:
- attack.privilege_escalation
- attack.credential_access
- attack.t1550.001
logsource:
  product: gcp
  service: gcp.audit
detection:
  selection:
    protoPayload.serviceName:
    - iam.googleapis.com
    - iamcredentials.googleapis.com
    protoPayload.methodName:
    - GenerateAccessToken
    - google.iam.credentials.v1.IAMCredentials.GenerateAccessToken
    resource.type: service_account
    protoPayload.status.code: 0
  filter_legitimate:
    protoPayload.authenticationInfo.principalEmail|endswith: .gserviceaccount.com
  condition: selection and not filter_legitimate
falsepositives:
- Legitimate break-glass procedures where an administrator manually impersonates a
  service account for emergency access.
- CI/CD pipelines or infrastructure-as-code tools that are configured to use user
  credentials instead of a dedicated service account (a non-recommended practice).
level: high
fields:
- protoPayload.authenticationInfo.principalEmail
- protoPayload.request.name
- resource.labels.project_id
- timestamp
test_scenarios:
  true_positive: An attacker with a compromised user account 'attacker@example.com'
    runs `gcloud iam service-accounts generate-access-token admin-sa@project.iam.gserviceaccount.com`
    to escalate privileges.
  false_negative: An attacker uses a compromised service account to impersonate another
    service account. This rule would not trigger as the filter condition would match.
  false_positive: A site reliability engineer 'sre@example.com' follows a documented
    break-glass runbook to impersonate a service account to fix a production issue.
  true_negative: A GKE node's service account authenticates to another GCP service,
    which involves token generation between service accounts.
  log_source_schema: https://cloud.google.com/logging/docs/audit#audit_log_entry_structure
  example_log_fields:
    protoPayload.methodName: google.iam.credentials.v1.IAMCredentials.GenerateAccessToken
    protoPayload.serviceName: iamcredentials.googleapis.com
    protoPayload.authenticationInfo.principalEmail: attacker@evil.com
