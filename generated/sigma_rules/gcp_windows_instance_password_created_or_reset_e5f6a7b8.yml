title: GCP Windows Instance Password Created or Reset
id: e5f6a7b8-c9d0-4b1c-8d2e-3f4a5b6c7d8e
status: experimental
description: Detects the creation or reset of a Windows user password on a Compute
  Engine instance via the GCP metadata API. This technique (T1098) allows an attacker
  with cloud permissions to gain OS-level access.
references:
- https://attack.mitre.org/techniques/T1098/
- https://cloud.google.com/compute/docs/instances/reset-windows-password
author: Automated Detection Agent
date: '2024-07-31'
modified: '2024-07-31'
tags:
- attack.privilege_escalation
- attack.t1098
logsource:
  product: gcp
  service: gcp.audit
detection:
  selection:
    protoPayload.serviceName: compute.googleapis.com
    protoPayload.methodName: v1.compute.instances.setMetadata
    protoPayload.request.metadata.items.key: windows-keys
    protoPayload.status.code: 0
  filter_legitimate: null
  condition: selection
falsepositives:
- A system administrator legitimately using the 'reset-windows-password' gcloud command
  or console feature to regain access to a VM.
- Automated account recovery processes that leverage this mechanism.
level: high
fields:
- protoPayload.authenticationInfo.principalEmail
- protoPayload.resourceName
- resource.labels.project_id
- timestamp
test_scenarios:
  true_positive: An attacker with Compute Admin rights uses `gcloud compute reset-windows-password`
    to create a new user and password for a domain controller VM.
  false_negative: An attacker uses a startup script to reset a local user password
    on a Linux VM, which would not involve the 'windows-keys' metadata key.
  false_positive: A help desk technician follows a standard procedure to reset a user's
    password on their Windows workstation VM.
  true_negative: An administrator reboots a Windows VM using the `v1.compute.instances.stop`
    and `v1.compute.instances.start` API calls.
  log_source_schema: https://cloud.google.com/logging/docs/audit#audit_log_entry_structure
  example_log_fields:
    protoPayload.methodName: v1.compute.instances.setMetadata
    protoPayload.request.metadata.items.key: windows-keys
    protoPayload.authenticationInfo.principalEmail: attacker-sa@project.iam.gserviceaccount.com
