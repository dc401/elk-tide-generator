name: Scattered Spider - GCP OS Password Reset
description: Detects attempts by threat actors like Scattered Spider to reset operating
  system passwords on GCP Compute Engine instances. This can be used for privilege
  escalation, persistence, or gaining access to additional systems.
type: query
query: event.category:api AND cloud.provider:gcp AND event.action:compute.instances.reset
  AND event.outcome:success
language: lucene
index:
- gcp.auditlog-*
filters: []
risk_score: 73
severity: high
threat:
- framework: MITRE ATT&CK
  tactic:
    id: TA0003
    name: Persistence
    reference: https://attack.mitre.org/tactics/TA0003/
  technique:
  - id: T1098
    name: Account Manipulation
    reference: https://attack.mitre.org/techniques/T1098/
- framework: MITRE ATT&CK
  tactic:
    id: TA0004
    name: Privilege Escalation
    reference: https://attack.mitre.org/tactics/TA0004/
  technique:
  - id: T1098
    name: Account Manipulation
    reference: https://attack.mitre.org/techniques/T1098/
references:
- https://attack.mitre.org/techniques/T1098/
- https://www.elastic.co/guide/en/ecs/current/ecs-cloud.html
author:
- Detection Agent
false_positives:
- Legitimate administrators resetting passwords for users or troubleshooting access
  issues.
note: '## Triage

  Investigate: the user identity, source IP, and the target instance for the password
  reset. Confirm if the action was authorized and expected.

  Escalate if: password reset is unexpected, performed by a suspicious account, or
  on a critical instance.'
test_cases:
- type: TP
  description: Successful OS password reset on a GCP compute instance
  log_entry:
    event:
      category: api
      type: change
      action: compute.instances.reset
      outcome: success
    cloud:
      provider: gcp
      service:
        name: compute.googleapis.com
    user:
      name: attacker@example.com
    gcp:
      audit:
        resource:
          type: instance
          name: windows-server-vm
    '@timestamp': '2024-03-12T22:40:00Z'
  expected_match: true
  evasion_technique: null
- type: FN
  description: Password reset via 'passwd' command within a Linux instance
  log_entry:
    event:
      category: process
      type: start
      code: 1
    process:
      name: passwd
      command_line: passwd user1
    '@timestamp': '2024-03-12T22:40:10Z'
  expected_match: false
  evasion_technique: This rule detects API calls for OS password resets, not direct
    OS commands executed within an instance.
- type: FP
  description: Legitimate stopping of a GCP compute instance
  log_entry:
    event:
      category: api
      type: stop
      action: compute.instances.stop
      outcome: success
    cloud:
      provider: gcp
      service:
        name: compute.googleapis.com
    user:
      name: admin@example.com
    '@timestamp': '2024-03-14T11:20:00Z'
  expected_match: false
  evasion_technique: null
- type: TN
  description: Normal GCP compute instance start
  log_entry:
    event:
      category: api
      type: start
      action: compute.instances.start
      outcome: success
    cloud:
      provider: gcp
      service:
        name: compute.googleapis.com
    user:
      name: dev@example.com
    '@timestamp': '2024-03-14T11:25:00Z'
  expected_match: false
  evasion_technique: null
