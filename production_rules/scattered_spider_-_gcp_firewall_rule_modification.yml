name: Scattered Spider - GCP Firewall Rule Modification
description: Detects attempts by Scattered Spider to create, update, patch, or delete
  Google Cloud Platform (GCP) firewall rules. Adversaries may modify firewall rules
  to establish persistence, facilitate C2 communication, or enable lateral movement.
type: query
query: event.category:api AND cloud.provider:gcp AND event.outcome:success AND event.action:(compute.firewalls.create
  OR compute.firewalls.update OR compute.firewalls.patch OR compute.firewalls.delete)
language: lucene
index:
- logs-*
- gcp.auditlog-*
filters: []
risk_score: 75
severity: high
threat:
- framework: MITRE ATT&CK
  tactic:
    id: TA0005
    name: Defense Evasion
    reference: https://attack.mitre.org/tactics/TA0005/
  technique:
  - id: T1562.007
    name: Disable or Modify Cloud Firewall
    reference: https://attack.mitre.org/techniques/T1562/007/
- framework: MITRE ATT&CK
  tactic:
    id: TA0003
    name: Persistence
    reference: https://attack.mitre.org/tactics/TA0003/
  technique:
  - id: T1098.005
    name: Cloud Account
    reference: https://attack.mitre.org/techniques/T1098/005/
references:
- https://attack.mitre.org/techniques/T1562/007/
- https://attack.mitre.org/techniques/T1098/005/
- https://www.elastic.co/guide/en/ecs/current/ecs-cloud.html
- https://cloud.google.com/compute/docs/reference/rest/v1/firewalls
author:
- Detection Agent
false_positives:
- Legitimate network administrators creating or modifying firewall rules for application
  deployment, network segmentation, or security policy updates.
note: '## Triage

  Investigate: the user account, the specific firewall rule changes (e.g., opening
  broad ports, allowing ingress from unknown IPs), and the timing. Correlate with
  change management records.'
test_cases:
- type: TP
  description: Successful creation of a new GCP firewall rule
  log_entry:
    event:
      category: api
      action: compute.firewalls.create
      outcome: success
    cloud:
      provider: gcp
    user:
      name: malicious-user@example.com
    gcp:
      audit:
        resource:
          type: compute.googleapis.com/Firewall
          name: allow-all-ingress
    '@timestamp': '2024-03-12T22:50:00Z'
  expected_match: true
  evasion_technique: null
- type: TP
  description: Successful update of an existing GCP firewall rule
  log_entry:
    event:
      category: api
      action: compute.firewalls.update
      outcome: success
    cloud:
      provider: gcp
    user:
      name: compromised-service-account@gcp-project.iam.gserviceaccount.com
    gcp:
      audit:
        resource:
          type: compute.googleapis.com/Firewall
          name: default-ssh
    '@timestamp': '2024-03-12T22:50:15Z'
  expected_match: true
  evasion_technique: null
- type: FN
  description: Modification of network routes (not firewall rules)
  log_entry:
    event:
      category: api
      action: compute.routes.update
      outcome: success
    cloud:
      provider: gcp
    user:
      name: malicious-user@example.com
    gcp:
      audit:
        resource:
          type: compute.googleapis.com/Route
          name: custom-route
    '@timestamp': '2024-03-12T22:51:00Z'
  expected_match: false
  evasion_technique: Modifies network routes directly, which is not covered by the
    firewall API calls in this rule.
- type: FP
  description: Legitimate admin creating a new firewall rule for a new application
  log_entry:
    event:
      category: api
      action: compute.firewalls.create
      outcome: success
    cloud:
      provider: gcp
    user:
      name: network-admin@example.com
    gcp:
      audit:
        resource:
          type: compute.googleapis.com/Firewall
          name: allow-app-port-8080
    '@timestamp': '2024-03-14T10:40:00Z'
  expected_match: false
  evasion_technique: null
- type: TN
  description: Normal GCP API call (storage bucket creation)
  log_entry:
    event:
      category: api
      action: storage.buckets.create
      outcome: success
    cloud:
      provider: gcp
    user:
      name: dev-user@example.com
    gcp:
      audit:
        resource:
          type: storage.googleapis.com/Bucket
          name: new-data-bucket
    '@timestamp': '2024-03-14T10:45:00Z'
  expected_match: false
  evasion_technique: null
