name: Scattered Spider - GCP Firewall Rule Modification
description: Detects attempts by Scattered Spider or other threat actors to create,
  modify, or delete Google Cloud Platform (GCP) firewall rules. Adversaries manipulate
  firewall rules to bypass network restrictions, enable C2, or facilitate data exfiltration.
type: query
query: event.category:api AND cloud.provider:gcp AND event.outcome:success AND event.action:(compute.firewalls.insert
  OR compute.firewalls.update OR compute.firewalls.patch OR compute.firewalls.delete)
language: lucene
index:
- gcp.audit.admin
- logs-*
filters: []
risk_score: 80
severity: high
threat:
- framework: MITRE ATT&CK
  tactic:
    id: TA0005
    name: Defense Evasion
    reference: https://attack.mitre.org/tactics/TA0005/
  technique:
  - id: T1562.007
    name: 'Impair Defenses: Disable or Modify Cloud Firewall'
    reference: https://attack.mitre.org/techniques/T1562/007/
- framework: MITRE ATT&CK
  tactic:
    id: TA0003
    name: Persistence
    reference: https://attack.mitre.org/tactics/TA0003/
  technique:
  - id: T1562.007
    name: 'Impair Defenses: Disable or Modify Cloud Firewall'
    reference: https://attack.mitre.org/techniques/T1562/007/
references:
- https://attack.mitre.org/techniques/T1562/007/
- https://cloud.google.com/logging/docs/audit/audit-log-fields
- https://www.elastic.co/guide/en/ecs/current/ecs-cloud.html
author:
- Detection Agent
false_positives:
- Legitimate network configuration changes by cloud administrators or automated infrastructure-as-code
  deployments.
note: '## Triage

  Investigate: user identity, source IP, and the specifics of the firewall rule change
  (e.g., new ports opened, IP ranges allowed). Correlate with change management records.

  Escalate if: changes are unauthorized, open broad access (e.g., 0.0.0.0/0), or are
  performed by unusual accounts.'
test_cases:
- type: TP
  description: Successful creation of a new GCP firewall rule
  log_entry:
    event:
      category: api
      action: compute.firewalls.insert
      outcome: success
    cloud:
      provider: gcp
      account:
        id: gcp-project-12345
    user:
      name: malicious-admin@example.com
    '@timestamp': '2024-03-12T22:40:00Z'
  expected_match: true
  evasion_technique: null
- type: TP
  description: Successful deletion of a GCP firewall rule
  log_entry:
    event:
      category: api
      action: compute.firewalls.delete
      outcome: success
    cloud:
      provider: gcp
      account:
        id: gcp-project-12345
    user:
      name: compromised-user@example.com
    '@timestamp': '2024-03-12T22:40:15Z'
  expected_match: true
  evasion_technique: null
- type: FN
  description: Evasion by modifying network routes directly on a VM
  log_entry:
    event:
      category: process
      type: start
    cloud:
      provider: gcp
      account:
        id: gcp-project-12345
    process:
      name: ip
      command_line: ip route add default via 10.128.0.1 dev eth0
    user:
      name: compromised-vm-user
    '@timestamp': '2024-03-12T22:41:00Z'
  expected_match: false
  evasion_technique: This rule focuses on API calls to modify cloud firewall rules.
    Modifying network routes directly on a compromised VM instance would bypass this
    detection.
- type: FP
  description: Failed attempt to update a GCP firewall rule
  log_entry:
    event:
      category: api
      action: compute.firewalls.update
      outcome: failure
    cloud:
      provider: gcp
      account:
        id: gcp-project-12345
    user:
      name: legitimate-admin@example.com
    '@timestamp': '2024-03-14T13:00:00Z'
  expected_match: false
  evasion_technique: null
- type: TN
  description: Benign GCP API call (listing firewall rules)
  log_entry:
    event:
      category: api
      action: compute.firewalls.list
      outcome: success
    cloud:
      provider: gcp
      account:
        id: gcp-project-12345
    user:
      name: auditor@example.com
    '@timestamp': '2024-03-14T13:05:00Z'
  expected_match: false
  evasion_technique: null
