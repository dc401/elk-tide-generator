name: Windows - Akira Ransomware Shadow Copy Deletion
description: Detects attempts by Akira ransomware to delete Volume Shadow Copies using
  command-line utilities like vssadmin, wmic, or bcdedit. This technique inhibits
  system recovery and is a precursor to data encryption.
type: query
query: event.category:process AND event.type:start AND process.name:(*vssadmin.exe
  OR *wmic.exe OR *bcdedit.exe) AND process.command_line:(*delete*shadows* OR *shadowcopy*delete*
  OR *recoveryenabled*no* OR *bootstatuspolicy*ignoreallfailures*)
language: lucene
index:
- winlogbeat-*
- logs-*
- filebeat-*
filters: []
risk_score: 80
severity: high
threat:
- framework: MITRE ATT&CK
  tactic:
    id: TA0040
    name: Impact
    reference: https://attack.mitre.org/tactics/TA0040/
  technique:
  - id: T1490
    name: Inhibit System Recovery
    reference: https://attack.mitre.org/techniques/T1490/
references:
- https://attack.mitre.org/techniques/T1490/
- https://www.elastic.co/guide/en/ecs/current/ecs-process.html
author:
- Detection Agent
false_positives:
- System administrators performing legitimate backup maintenance or troubleshooting.
- Legitimate software uninstallers that remove shadow copies.
note: '## Triage

  Investigate: parent process, user context, and timing of execution. Look for multiple
  instances or unusual timing. Correlate with other security events.

  Escalate if: executed by a non-administrative user, occurs outside of scheduled
  maintenance windows, or originates from a suspicious parent process.'
test_cases:
- type: TP
  description: Malicious vssadmin shadow deletion
  log_entry:
    event:
      category: process
      type: start
      code: 1
    process:
      name: vssadmin.exe
      command_line: vssadmin delete shadows /all /quiet
      executable: C:\Windows\System32\vssadmin.exe
    user:
      name: Administrator
    '@timestamp': '2024-03-12T22:15:10Z'
  expected_match: true
  evasion_technique: null
- type: TP
  description: Malicious wmic shadow copy deletion
  log_entry:
    event:
      category: process
      type: start
      code: 1
    process:
      name: wmic.exe
      command_line: wmic shadowcopy delete
      executable: C:\Windows\System32\wbem\wmic.exe
    user:
      name: SYSTEM
    '@timestamp': '2024-03-12T22:15:20Z'
  expected_match: true
  evasion_technique: null
- type: TP
  description: Malicious bcdedit to disable recovery
  log_entry:
    event:
      category: process
      type: start
      code: 1
    process:
      name: bcdedit.exe
      command_line: bcdedit /set {default} recoveryenabled no
      executable: C:\Windows\System32\bcdedit.exe
    user:
      name: Administrator
    '@timestamp': '2024-03-12T22:15:30Z'
  expected_match: true
  evasion_technique: null
- type: FN
  description: PowerShell evasion using WMI API to delete shadow copies
  log_entry:
    event:
      category: process
      type: start
      code: 1
    process:
      name: powershell.exe
      command_line: Get-WmiObject Win32_ShadowCopy | ForEach-Object {$_.Delete()}
    user:
      name: Administrator
    '@timestamp': '2024-03-12T22:16:00Z'
  expected_match: false
  evasion_technique: Uses PowerShell cmdlets and WMI API directly instead of command-line
    tools (vssadmin, wmic, bcdedit), bypassing detection focused on specific executable
    names and command-line arguments.
- type: FP
  description: Admin checking shadow copy status
  log_entry:
    event:
      category: process
      type: start
      code: 1
    process:
      name: vssadmin.exe
      command_line: vssadmin list shadows
      executable: C:\Windows\System32\vssadmin.exe
    user:
      name: Administrator
    '@timestamp': '2024-03-14T10:00:00Z'
  expected_match: false
  evasion_technique: null
- type: TN
  description: Normal system activity (explorer.exe)
  log_entry:
    event:
      category: process
      type: start
      code: 1
    process:
      name: explorer.exe
      command_line: C:\Windows\explorer.exe
      executable: C:\Windows\explorer.exe
    user:
      name: User1
    '@timestamp': '2024-03-14T10:05:00Z'
  expected_match: false
  evasion_technique: null
