name: Scattered Spider - GCP Compute Snapshot Deletion
description: Detects attempts by Scattered Spider or other threat actors to delete
  Google Cloud Platform (GCP) compute snapshots. This action is a common technique
  to destroy backups and inhibit system recovery, increasing the impact of an attack.
type: query
query: event.category:api AND cloud.provider:gcp AND event.action:compute.snapshots.delete
  AND event.outcome:success
language: lucene
index:
- gcp.audit.admin
- logs-*
filters: []
risk_score: 90
severity: critical
threat:
- framework: MITRE ATT&CK
  tactic:
    id: TA0040
    name: Impact
    reference: https://attack.mitre.org/tactics/TA0040/
  technique:
  - id: T1485
    name: Data Destruction
    reference: https://attack.mitre.org/techniques/T1485/
- framework: MITRE ATT&CK
  tactic:
    id: TA0005
    name: Defense Evasion
    reference: https://attack.mitre.org/tactics/TA0005/
  technique:
  - id: T1562.003
    name: 'Impair Defenses: Impair Command History Logging'
    reference: https://attack.mitre.org/techniques/T1562/003/
references:
- https://attack.mitre.org/techniques/T1485/
- https://attack.mitre.org/techniques/T1562/003/
- https://cloud.google.com/logging/docs/audit/audit-log-fields
- https://www.elastic.co/guide/en/ecs/current/ecs-cloud.html
author:
- Detection Agent
false_positives:
- Legitimate backup rotation or cleanup by administrators or automated processes.
note: '## Triage

  Investigate: user identity, source IP, and timing of the API call. Confirm if the
  deletion was authorized and part of a planned maintenance activity.

  Escalate if: deletion is unexpected, performed by an unusual user, or outside of
  normal operational hours.'
test_cases:
- type: TP
  description: Successful deletion of a GCP compute snapshot
  log_entry:
    event:
      category: api
      action: compute.snapshots.delete
      outcome: success
    cloud:
      provider: gcp
      account:
        id: gcp-project-12345
    user:
      name: malicious-user@example.com
    '@timestamp': '2024-03-12T22:20:00Z'
  expected_match: true
  evasion_technique: null
- type: TP
  description: Another successful deletion of a GCP compute snapshot
  log_entry:
    event:
      category: api
      action: compute.snapshots.delete
      outcome: success
    cloud:
      provider: gcp
      account:
        id: gcp-project-12345
    user:
      name: compromised-service-account@gcp-project-12345.iam.gserviceaccount.com
    '@timestamp': '2024-03-12T22:21:00Z'
  expected_match: true
  evasion_technique: null
- type: FN
  description: Evasion by deleting the underlying disk instead of the snapshot
  log_entry:
    event:
      category: api
      action: compute.disks.delete
      outcome: success
    cloud:
      provider: gcp
      account:
        id: gcp-project-12345
    user:
      name: malicious-user@example.com
    '@timestamp': '2024-03-12T22:22:00Z'
  expected_match: false
  evasion_technique: This rule specifically targets snapshot deletion API calls. Deleting
    the underlying disk directly would bypass this rule.
- type: FP
  description: Failed attempt to delete a GCP compute snapshot
  log_entry:
    event:
      category: api
      action: compute.snapshots.delete
      outcome: failure
    cloud:
      provider: gcp
      account:
        id: gcp-project-12345
    user:
      name: legitimate-user@example.com
    '@timestamp': '2024-03-14T11:00:00Z'
  expected_match: false
  evasion_technique: null
- type: TN
  description: Benign GCP API call (listing instances)
  log_entry:
    event:
      category: api
      action: compute.instances.list
      outcome: success
    cloud:
      provider: gcp
      account:
        id: gcp-project-12345
    user:
      name: monitoring-service-account@gcp-project-12345.iam.gserviceaccount.com
    '@timestamp': '2024-03-14T11:05:00Z'
  expected_match: false
  evasion_technique: null
