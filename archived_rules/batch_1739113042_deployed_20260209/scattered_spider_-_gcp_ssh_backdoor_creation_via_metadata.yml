name: Scattered Spider - GCP SSH Backdoor Creation via Metadata
description: Detects attempts by Scattered Spider to establish an SSH backdoor by
  adding SSH keys to GCP instance or project-wide metadata. This provides persistent
  and covert remote access to compute instances.
type: query
query: event.category:api AND cloud.provider:gcp AND event.outcome:success AND event.action:(compute.instances.setMetadata
  OR compute.project.setCommonInstanceMetadata) AND gcp.audit.request.metadata.key:ssh-keys
language: lucene
index:
- logs-*
- gcp.auditlog-*
filters: []
risk_score: 80
severity: high
threat:
- framework: MITRE ATT&CK
  tactic:
    id: TA0003
    name: Persistence
    reference: https://attack.mitre.org/tactics/TA0003/
  technique:
  - id: T1098.004
    name: SSH Authorized Keys
    reference: https://attack.mitre.org/techniques/T1098/004/
- framework: MITRE ATT&CK
  tactic:
    id: TA0003
    name: Persistence
    reference: https://attack.mitre.org/tactics/TA0003/
  technique:
  - id: T1136.002
    name: Cloud Account
    reference: https://attack.mitre.org/techniques/T1136/002/
references:
- https://attack.mitre.org/techniques/T1098/004/
- https://attack.mitre.org/techniques/T1136/002/
- https://www.elastic.co/guide/en/ecs/current/ecs-cloud.html
- https://cloud.google.com/compute/docs/instances/adding-removing-ssh-keys#metadata
author:
- Detection Agent
false_positives:
- Legitimate administrators adding SSH keys for new users, automation, or secure access
  to instances. Requires context and correlation with approved changes.
note: '## Triage

  Investigate: the user account adding the SSH key, the key itself (if possible),
  and the target instance/project. Verify if the action was authorized and expected.'
test_cases:
- type: TP
  description: Successful addition of SSH key to instance metadata
  log_entry:
    event:
      category: api
      action: compute.instances.setMetadata
      outcome: success
    cloud:
      provider: gcp
    user:
      name: malicious-user@example.com
    gcp:
      audit:
        request:
          metadata:
            key: ssh-keys
            value: ssh-rsa AAAA... attacker@host
    '@timestamp': '2024-03-12T23:00:00Z'
  expected_match: true
  evasion_technique: null
- type: TP
  description: Successful addition of SSH key to project-wide metadata
  log_entry:
    event:
      category: api
      action: compute.project.setCommonInstanceMetadata
      outcome: success
    cloud:
      provider: gcp
    user:
      name: compromised-admin@example.com
    gcp:
      audit:
        request:
          metadata:
            key: ssh-keys
            value: ssh-rsa BBBB... backdoor@project
    '@timestamp': '2024-03-12T23:00:15Z'
  expected_match: true
  evasion_technique: null
- type: FN
  description: SSH key added directly to authorized_keys file on instance (not via
    GCP API)
  log_entry:
    event:
      category: file
      type: change
    cloud:
      provider: gcp
    user:
      name: root
    file:
      path: /home/user/.ssh/authorized_keys
    '@timestamp': '2024-03-12T23:01:00Z'
  expected_match: false
  evasion_technique: SSH key added directly to the file system of a compromised instance,
    bypassing GCP API audit logs for metadata changes.
- type: FP
  description: Legitimate admin adding SSH key for a new developer
  log_entry:
    event:
      category: api
      action: compute.instances.setMetadata
      outcome: success
    cloud:
      provider: gcp
    user:
      name: it-admin@example.com
    gcp:
      audit:
        request:
          metadata:
            key: ssh-keys
            value: ssh-rsa CCCC... dev@instance
    '@timestamp': '2024-03-14T10:50:00Z'
  expected_match: false
  evasion_technique: null
- type: TN
  description: Normal GCP API call (instance stop)
  log_entry:
    event:
      category: api
      action: compute.instances.stop
      outcome: success
    cloud:
      provider: gcp
    user:
      name: ops-user@example.com
    gcp:
      audit:
        resource:
          type: compute.googleapis.com/Instance
          name: web-server-01
    '@timestamp': '2024-03-14T10:55:00Z'
  expected_match: false
  evasion_technique: null
