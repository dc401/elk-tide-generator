name: Akira Ransomware - Service Stop via CLI
description: Detects attempts by Akira ransomware to stop critical services or disable
  their startup using command-line tools like net.exe, sc.exe, or taskkill.exe. This
  is done to unlock files for encryption or disable security/backup tools.
type: query
query: event.category:process AND event.type:start AND event.code:(1 OR 4688) AND
  ((process.name:*net.exe* AND process.command_line:(*stop*)) OR (process.name:*sc.exe*
  AND process.command_line:(*config* AND *start*=disabled*)) OR (process.name:*taskkill.exe*
  AND process.command_line:(*F* AND *IM*)))
language: lucene
index:
- logs-*
- winlogbeat-*
- filebeat-*
filters: []
risk_score: 80
severity: high
threat:
- framework: MITRE ATT&CK
  tactic:
    id: TA0040
    name: Impact
    reference: https://attack.mitre.org/tactics/TA0040/
  technique:
  - id: T1489
    name: Service Stop
    reference: https://attack.mitre.org/techniques/T1489/
references:
- https://attack.mitre.org/techniques/T1489/
- https://www.elastic.co/guide/en/ecs/current/ecs-process.html
- https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4688
author:
- Detection Agent
false_positives:
- System administrators performing legitimate service maintenance or troubleshooting.
- Automated deployment or patching scripts that manage services.
note: '## Triage

  Investigate: parent process, user context, timing, and the specific service being
  stopped/disabled.

  Escalate if: executed by non-admin accounts, targeting security or backup services,
  or occurring during unusual hours.'
test_cases:
- type: TP
  description: Malicious net stop command
  log_entry:
    event:
      category: process
      type: start
      code: 4688
    process:
      name: net.exe
      command_line: net stop "Veeam Backup Service" /y
      executable: C:\Windows\System32\net.exe
    '@timestamp': '2024-03-12T22:20:00Z'
  expected_match: true
  evasion_technique: null
- type: TP
  description: Malicious sc config to disable service
  log_entry:
    event:
      category: process
      type: start
      code: 1
    process:
      name: sc.exe
      command_line: sc config "Sophos Agent" start= disabled
      executable: C:\Windows\System32\sc.exe
    '@timestamp': '2024-03-12T22:20:15Z'
  expected_match: true
  evasion_technique: null
- type: TP
  description: Malicious taskkill to terminate process
  log_entry:
    event:
      category: process
      type: start
      code: 4688
    process:
      name: taskkill.exe
      command_line: taskkill /F /IM sqlservr.exe
      executable: C:\Windows\System32\taskkill.exe
    '@timestamp': '2024-03-12T22:20:30Z'
  expected_match: true
  evasion_technique: null
- type: FN
  description: PowerShell Stop-Service cmdlet
  log_entry:
    event:
      category: process
      type: start
      code: 4688
    process:
      name: powershell.exe
      command_line: Stop-Service -Name 'MSSQLSERVER'
    '@timestamp': '2024-03-12T22:21:00Z'
  expected_match: false
  evasion_technique: Uses PowerShell cmdlet instead of direct net.exe, sc.exe, or
    taskkill.exe. This rule focuses on specific executable names.
- type: FP
  description: Admin starting a service
  log_entry:
    event:
      category: process
      type: start
      code: 4688
    process:
      name: net.exe
      command_line: net start "Print Spooler"
      executable: C:\Windows\System32\net.exe
    '@timestamp': '2024-03-14T10:10:00Z'
  expected_match: false
  evasion_technique: null
- type: TN
  description: Normal process execution
  log_entry:
    event:
      category: process
      type: start
      code: 4688
    process:
      name: notepad.exe
      command_line: notepad.exe C:\temp\notes.txt
      executable: C:\Windows\System32\notepad.exe
    '@timestamp': '2024-03-14T10:15:00Z'
  expected_match: false
  evasion_technique: null
