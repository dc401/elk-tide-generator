name: Scattered Spider - GCP OS Windows Password Reset
description: Detects attempts by Scattered Spider to reset the operating system password
  for a GCP Windows compute instance. This indicates potential account manipulation
  and credential compromise, granting direct access to the OS.
type: query
query: event.category:api AND cloud.provider:gcp AND event.outcome:success AND event.action:compute.instances.resetWindowsPassword
language: lucene
index:
- logs-*
- gcp.auditlog-*
filters: []
risk_score: 85
severity: high
threat:
- framework: MITRE ATT&CK
  tactic:
    id: TA0004
    name: Privilege Escalation
    reference: https://attack.mitre.org/tactics/TA0004/
  technique:
  - id: T1098
    name: Account Manipulation
    reference: https://attack.mitre.org/techniques/T1098/
- framework: MITRE ATT&CK
  tactic:
    id: TA0006
    name: Credential Access
    reference: https://attack.mitre.org/tactics/TA0006/
  technique:
  - id: T1552
    name: Unsecured Credentials
    reference: https://attack.mitre.org/techniques/T1552/
references:
- https://attack.mitre.org/techniques/T1098/
- https://attack.mitre.org/techniques/T1552/
- https://www.elastic.co/guide/en/ecs/current/ecs-cloud.html
- https://cloud.google.com/compute/docs/instances/windows/reset-windows-password
author:
- Detection Agent
false_positives:
- Legitimate administrators resetting a Windows instance password for troubleshooting
  or user management. Requires context and correlation with approved changes.
note: '## Triage

  Investigate: the user account initiating the password reset, the target instance,
  and the timing. Verify if the action was authorized and expected. This is a high-impact
  event.'
test_cases:
- type: TP
  description: Successful reset of a Windows instance password
  log_entry:
    event:
      category: api
      action: compute.instances.resetWindowsPassword
      outcome: success
    cloud:
      provider: gcp
    user:
      name: malicious-user@example.com
    gcp:
      audit:
        resource:
          type: compute.googleapis.com/Instance
          name: windows-server-prod
    '@timestamp': '2024-03-12T23:20:00Z'
  expected_match: true
  evasion_technique: null
- type: TP
  description: Another successful reset of a Windows instance password
  log_entry:
    event:
      category: api
      action: compute.instances.resetWindowsPassword
      outcome: success
    cloud:
      provider: gcp
    user:
      name: compromised-admin@example.com
    gcp:
      audit:
        resource:
          type: compute.googleapis.com/Instance
          name: sql-db-windows
    '@timestamp': '2024-03-12T23:20:10Z'
  expected_match: true
  evasion_technique: null
- type: FN
  description: Password reset performed directly within the OS (e.g., net user command)
  log_entry:
    event:
      category: process
      type: start
    cloud:
      provider: gcp
    user:
      name: Administrator
    process:
      name: net.exe
      command_line: net user compromiseduser newpassword
    '@timestamp': '2024-03-12T23:21:00Z'
  expected_match: false
  evasion_technique: Password reset performed directly on the instance's OS, bypassing
    GCP API audit logs.
- type: FP
  description: Legitimate admin resetting a Windows instance password for a user
  log_entry:
    event:
      category: api
      action: compute.instances.resetWindowsPassword
      outcome: success
    cloud:
      provider: gcp
    user:
      name: it-helpdesk@example.com
    gcp:
      audit:
        resource:
          type: compute.googleapis.com/Instance
          name: user-dev-vm
    '@timestamp': '2024-03-14T11:10:00Z'
  expected_match: false
  evasion_technique: null
- type: TN
  description: Normal GCP API call (instance start)
  log_entry:
    event:
      category: api
      action: compute.instances.start
      outcome: success
    cloud:
      provider: gcp
    user:
      name: ops-user@example.com
    gcp:
      audit:
        resource:
          type: compute.googleapis.com/Instance
          name: web-server-02
    '@timestamp': '2024-03-14T11:15:00Z'
  expected_match: false
  evasion_technique: null
