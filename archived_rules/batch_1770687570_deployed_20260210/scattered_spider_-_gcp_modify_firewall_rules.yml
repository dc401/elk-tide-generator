name: Scattered Spider - GCP Modify Firewall Rules
description: Detects attempts by threat actors like Scattered Spider to create or
  modify Google Cloud firewall rules. Adversaries modify firewall rules to control
  network access for defense evasion, lateral movement, or command and control.
type: query
query: event.category:api AND cloud.provider:gcp AND event.action:(compute.firewalls.insert
  OR compute.firewalls.update) AND event.outcome:success
language: lucene
index:
- gcp.auditlog-*
filters: []
risk_score: 73
severity: high
threat:
- framework: MITRE ATT&CK
  tactic:
    id: TA0005
    name: Defense Evasion
    reference: https://attack.mitre.org/tactics/TA0005/
  technique:
  - id: T1562.007
    name: 'Impair Defenses: Disable or Modify Cloud Security Controls'
    reference: https://attack.mitre.org/techniques/T1562/007/
references:
- https://attack.mitre.org/techniques/T1562/007/
- https://www.elastic.co/guide/en/ecs/current/ecs-cloud.html
author:
- Detection Agent
false_positives:
- Legitimate network administrators creating or updating firewall rules for business
  operations.
- Automated infrastructure-as-code deployments.
note: '## Triage

  Investigate: the user identity, source IP, and the specifics of the firewall rule
  change (e.g., ports opened, source/destination IPs). Correlate with other activity.

  Escalate if: rules are created/modified to allow unusual ingress/egress, or by an
  unauthorized account.'
test_cases:
- type: TP
  description: Successful creation of a new GCP firewall rule
  log_entry:
    event:
      category: api
      type: creation
      action: compute.firewalls.insert
      outcome: success
    cloud:
      provider: gcp
      service:
        name: compute.googleapis.com
    user:
      name: attacker@example.com
    gcp:
      audit:
        resource:
          type: firewall
          name: allow-all-ingress
    '@timestamp': '2024-03-12T22:35:00Z'
  expected_match: true
  evasion_technique: null
- type: TP
  description: Successful update of an existing GCP firewall rule
  log_entry:
    event:
      category: api
      type: change
      action: compute.firewalls.update
      outcome: success
    cloud:
      provider: gcp
      service:
        name: compute.googleapis.com
    user:
      name: attacker@example.com
    gcp:
      audit:
        resource:
          type: firewall
          name: default-ssh
    '@timestamp': '2024-03-12T22:35:10Z'
  expected_match: true
  evasion_technique: null
- type: FN
  description: Firewall rule modification via gcloud CLI (assuming different API call)
  log_entry:
    event:
      category: api
      type: change
      action: gcloud.compute.firewall-rules.update
      outcome: success
    cloud:
      provider: gcp
      service:
        name: compute.googleapis.com
    user:
      name: attacker@example.com
    '@timestamp': '2024-03-12T22:36:00Z'
  expected_match: false
  evasion_technique: This rule specifically targets 'compute.firewalls.insert' and
    'compute.firewalls.update' API calls. Other gcloud commands might map to different
    underlying APIs.
- type: FP
  description: Legitimate listing of GCP firewall rules
  log_entry:
    event:
      category: api
      type: info
      action: compute.firewalls.list
      outcome: success
    cloud:
      provider: gcp
      service:
        name: compute.googleapis.com
    user:
      name: admin@example.com
    '@timestamp': '2024-03-14T11:10:00Z'
  expected_match: false
  evasion_technique: null
- type: TN
  description: Normal GCP compute instance deletion
  log_entry:
    event:
      category: api
      type: deletion
      action: compute.instances.delete
      outcome: success
    cloud:
      provider: gcp
      service:
        name: compute.googleapis.com
    user:
      name: dev@example.com
    '@timestamp': '2024-03-14T11:15:00Z'
  expected_match: false
  evasion_technique: null
